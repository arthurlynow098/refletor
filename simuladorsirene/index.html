<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulação Sirene - FLASH (Versão Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos Globais e Layout Principal */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background-color: #f8f9fa; height: 100vh; overflow: hidden; color: #333; }
        .header { background-color: #2c3e50; height: 40px; display: flex; align-items: center; padding: 0 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { height: 24px; }
        .navbar { background-color: #f39c12; height: 32px; display: flex; align-items: center; padding: 0 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav-item { margin-right: 20px; font-weight: 500; font-size: 11.5px; color: #2c3e50; cursor: pointer; transition: all 0.2s ease; padding: 4px 8px; border-radius: 4px; }
        .nav-item:hover { background-color: rgba(255,255,255,0.2); color: #fff; }
        .main-container { display: flex; height: calc(100vh - 72px); }
        .panel { padding: 15px; height: 100%; border-right: 1px solid #e9ecef; }
        .left-panel { width: 50%; background-color: #ffffff; display: flex; flex-direction: column; overflow: hidden; }
        .right-panel-container { width: 50%; display: flex; flex-direction: column; }
        .center-panel { flex-grow: 1; min-height: 250px; background-color: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #e9ecef; padding: 15px; }
        .right-panel { flex-shrink: 0; width: 100%; background-color: #ffffff; border-right: none; overflow: auto; padding: 24px; }
        .panel-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #2c3e50; padding-bottom: 6px; border-bottom: 2px solid #f39c12; flex-shrink: 0; }
        .form-group { margin-bottom: 9px; }
        .form-label { display: block; margin-bottom: 4px; font-weight: 500; color: #495057; font-size: 10.5px; text-transform: uppercase; letter-spacing: 0.3px; }
        .form-value, .config-input, .form-select { padding: 7px 9px; background-color: #ffffff; border: 1px solid #ced4da; border-radius: 4px; font-size: 11.5px; color: #495057; font-weight: 400; width: 100%; }
        .config-input:focus, .form-select:focus { outline: none; border-color: #f39c12; box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.2); }
        
        .simulation-area { 
            width: 100%; 
            height: 100%; 
            background-color: #e9ecef; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); 
            position: relative; 
            overflow: hidden; 
        }
        #siren-model-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 98%;
            max-height: 98%;
            height: auto;
            z-index: 1; 
        }
        #blocks-container {
            position: relative;
            z-index: 2; 
            width: 100%;
            height: 100%;
        }

        .output-item { background-color: #f8f9fa; padding: 8px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #f39c12; }
        .output-label { font-weight: 600; color: #495057; margin-bottom: 3px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px; }
        .output-value { color: #6c757d; font-size: 11.5px; font-weight: 400; }
        .btn { background-color: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; font-size: 11.5px; letter-spacing: 0.3px; }
        .btn:hover { background-color: #e67e22; transform: translateY(-1px); }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: #ffffff; width: 30%; max-width: 500px; max-height: 90vh; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid #e9ecef; text-align: right; }
        .close-button { background: none; border: none; font-size: 24px; font-weight: bold; cursor: pointer; color: #6c757d; }
        .excel-container { background-color: white; border: 1px solid #d0d7de; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-grow: 1; display: flex; flex-direction: column; height: calc(100% - 82px); }
        .excel-toolbar { background-color: #f8f9fa; border-bottom: 1px solid #d0d7de; padding: 6px 12px; font-size: 10px; color: #666; flex-shrink: 0; }
        .excel-grid { overflow: auto; flex-grow: 1; }
        .macro-table { width: 100%; border-collapse: collapse; font-size: 9px; font-family: 'Calibri', Arial, sans-serif; table-layout: fixed; }
        .macro-table th, .macro-table td { border: 1px solid #d0d7de; padding: 2px 4px; text-align: center; min-width: 30px; height: 18px; vertical-align: middle; overflow: hidden; white-space: nowrap; }
        .column-header { background-color: #d9e1f2; font-weight: bold; font-size: 9px; color: #333; cursor: pointer; }
        .macro-table th.column-header { position: sticky; top: 0; z-index: 1; }
        .sheet-selector-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; border-bottom: 2px solid #d0d7de; padding-bottom: 6px; }
        .sheet-selector-btn { background-color: #e9ecef; border: 1px solid #ced4da; border-bottom: none; padding: 5px 10px; cursor: pointer; font-size: 11.5px; font-weight: 500; border-radius: 4px 4px 0 0; transition: all 0.2s ease; color: #495057; }
        .sheet-selector-btn.active { background-color: #ffffff; border-color: #d0d7de; color: #2c3e50; font-weight: 600; transform: translateY(2px); }
        .macro-controls { display: flex; gap: 8px; align-items: center; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; flex-shrink: 0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .checkbox-item { display: flex; align-items: center; font-size: 11.5px; transition: all 0.2s ease; padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; }
        .modal-nav-tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 15px; flex-wrap: wrap; }
        .modal-tab-btn { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 14px; font-weight: 500; color: #495057; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .modal-tab-btn:hover { background-color: #f8f9fa; }
        .modal-tab-btn.active { color: #f39c12; border-color: #f39c12; }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        .description { font-size: 13px; color: #6c757d; background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        .function-table-container { margin-bottom: 15px; }
        .function-title { font-size: 16px; color: #2c3e50; margin-bottom: 12px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .function-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .function-table th, .function-table td { border: 1px solid #ced4da; padding: 6px; text-align: center; transition: background-color 0.2s ease; }
        .function-table th { background-color: #e9ecef; font-weight: 600; }
        .function-table th:first-child, .function-table td:first-child { width: 110px; text-align: left; padding-left: 8px; }
        .function-table td[contenteditable="true"] { background-color: #fff; }
        .function-table td[contenteditable="true"]:focus { background-color: #fff3cd; outline: 2px solid #f39c12; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
        .checkbox-item input { margin-right: 8px; cursor: pointer; }
        .relative { position: relative; width: 100%; height: 100%; }
        .function-group { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #fdfdfd; }
        .function-group-title { font-size: 18px; color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .function-group .function-table-container { margin-bottom: 0; }
        .function-group .function-table-container + .function-table-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .fp-setting-id { display: inline-block; min-width: 30px; font-weight: 600; color: #e67e22; }
        .fp-setting-description { display: block; font-size: 11px; color: #6c757d; margin-top: 4px; font-style: italic; }
        .checkbox-item.active-setting { background-color: #fffbe6; border-color: #f39c12; font-weight: 500; }
        .function-table td.cell-active-function { background-color: #e6ffed !important; font-weight: bold; }
        .control-btn.active { background-color: #2ecc71 !important; color: white !important; border: 2px solid #27ae60; transform: scale(1.05); }
        .status-panel-list ul { list-style-type: none; padding-left: 0; margin-top: 5px; }
        .status-panel-list li { font-size: 11px; color: #495057; padding: 3px 0; border-bottom: 1px solid #ced4da; }
        .status-panel-list li:last-child { border-bottom: none; }
        .status-panel-list li .func-name { font-weight: 600; color: #333; }
        .status-panel-list .no-settings { font-size: 11px; color: #6c757d; font-style: italic; }
        #jumptabela-status-output { background-color: #e9ecef; border-left-color: #34495e; }
        #special-functions-status-output { background-color: #e7f5ff; border-left-color: #3498db; }
        .ms25-column, .ms-column { font-weight: bold; font-size: 9px; cursor: cell; }
        .ms25-column { background-color: #e9ecef; color: red; }
        .ms-column { background-color: #fff; color: black; }
        .editable-cell { background-color: #fff; cursor: cell; transition: all 0.2s ease; }
        .editable-cell:hover, .ms25-column:hover, .ms-column:hover { background-color: #f8f9fa; }
        .editable-cell:focus, .ms25-column:focus, .ms-column:focus { background-color: #fff3cd; outline: 2px solid #0066cc; }
        .cell-red { background-color: #ff0000 !important; color: white; font-weight: bold; }
        .cell-blue { background-color: #0070c0 !important; color: white; font-weight: bold; }
        .cell-white { background-color: #ffffff !important; color: black; font-weight: bold; border: 1px solid #555 !important; }
        .cell-yellow { background-color: #ffc000 !important; color: black; font-weight: bold; }
        .selected-row { background-color: #fff3cd !important; outline: 2px solid #f39c12; outline-offset: -2px; }
        .cell-selected { background-color: #d0e3ff !important; outline: 1px solid #4a89dc; }
        .row-counter-column { background-color: #e9ecef; font-weight: bold; font-size: 9px; color: #333; }
        .block-container { position: absolute; overflow: visible; }
        .block-part-single {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 8px; color: #1f2937; transition: all 0.1s ease-in-out;
            border: 1px solid rgba(0,0,0,0.2); border-radius: 4px;
        }
        .block-part-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden;
        }
        .block-part-top, .block-part-bottom {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 8px; color: #1f2937; transition: all 0.1s ease-in-out;
        }
        .block-part-top { border-bottom: 1px solid rgba(0,0,0,0.2); }
        .layout-color-red { background-color: #ff0000; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .layout-color-blue { background-color: #2563eb; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .layout-color-green { background-color: #2ecc71; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .layout-color-white { background-color: #ffffff; color: black; text-shadow: none; }
        .layout-color-yellow { background-color: #ffc000; color: black; text-shadow: 1px 1px 1px rgba(255,255,255,0.5); }
        .layout-color-off { background-color: #d1d5db; text-shadow: none; }
        .simulation-area.edit-mode .block-container { cursor: move; border: 1px dashed #3498db; }
        .block-container.selected { outline: 2px solid #3498db; z-index: 10; }
        .interaction-handle { position: absolute; background-color: #3498db; border: 1px solid white; display: none; }
        .block-container.selected .interaction-handle { display: block; }
        .resize-handle { width: 12px; height: 12px; bottom: -6px; right: -6px; cursor: nwse-resize; }
        .rotate-handle { width: 14px; height: 14px; top: -20px; left: calc(50% - 7px); border-radius: 50%; cursor: grab; }
        .rotate-handle:active { cursor: grabbing; }
        .layout-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .layout-category-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #f39c12; grid-column: 1 / -1; }
        .layout-category-title:first-child { margin-top: 0; }
        .layout-preview-item { border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.2s ease-in-out; background-color: #fff; display: flex; flex-direction: column; }
        .layout-preview-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #f39c12; }
        .layout-preview-item img { width: 100%; height: 120px; object-fit: contain; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .layout-preview-item p { padding: 10px; font-size: 12px; font-weight: 500; text-align: center; color: #495057; margin: 0; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        #color-context-menu {
            display: none; position: absolute; z-index: 10000; background-color: #fff;
            border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px; padding: 5px 0; list-style: none; font-size: 12px;
        }
        #color-context-menu li { padding: 8px 15px; cursor: pointer; }
        #color-context-menu li:hover { background-color: #f39c12; color: white; }
        #color-context-menu hr { border: none; border-top: 1px solid #eee; margin: 4px 0; }
        .persistent-color-red { background-color: #f8d7da !important; color: black !important; }
        .persistent-color-green { background-color: #d1e7dd !important; color: black !important; }
        .persistent-color-blue { background-color: #cce5ff !important; color: black !important; }
        .persistent-color-white { background-color: #e9ecef !important; color: black !important; }
        .persistent-color-yellow { background-color: #fff3cd !important; color: black !important; }
        .instruction-text { font-size: 11px; color: #6c757d; margin-bottom: 8px; padding-left: 4px; }
    </style>
</head>
<body>
    
    <ul id="color-context-menu">
        <li data-color="red">Vermelha</li>
        <li data-color="green">Verde</li>
        <li data-color="blue">Azul</li>
        <li data-color="white">Branca</li>
        <li data-color="yellow">Âmbar</li>
        <hr>
        <li data-color="clear">Limpar Cor</li>
    </ul>

    <div id="layout-panel-modal" class="modal-overlay">
        <div class="modal-content" style="width: 80%; max-width: 1200px;">
            <div class="modal-header">
                <div class="panel-title" style="margin-bottom: 0; border-bottom: none;"><i class="fa fa-th-large"></i> Selecione um Modelo de Sinalizador</div>
                <button class="close-button" id="close-layout-panel-btn">&times;</button>
            </div>
            <div class="modal-body" id="layout-panel-body"></div>
        </div>
    </div>

    <div id="advanced-settings-modal" class="modal-overlay">
        <div class="modal-content" style="width: 80%; max-width: 1200px;">
            <div class="modal-header">
                <div class="panel-title" style="margin-bottom: 0; border-bottom: none;"><i class="fa fa-cogs"></i> Definições Avançadas de Funcionamento</div>
                <button class="close-button" id="close-advanced-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-nav-tabs">
                    <button class="modal-tab-btn active" data-tab="tab-special-functions">Funções Especiais</button>
                    <button class="modal-tab-btn" data-tab="tab-jumptabela">JumpTabela</button>
                </div>
                <div class="modal-tab-content-container">
                    <div id="tab-special-functions" class="modal-tab-content active">
                        <p class="description">Configure quais blocos devem acender ou apagar para cada função especial. Para ativar um bloco para uma função, digite "1" na coluna correspondente ao número do bloco.</p>
                        <div class="function-group">
                            <h3 class="function-group-title">Take Down (TD)</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="takedown" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="takedown_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Alley-Right (LD)</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="alley_right" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="alley_right_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Alley-Left (LE)</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="alley_left" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="alley_left_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Backlight Activate</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="backlight_off" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="backlight_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Cut Front</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_front_off" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_front_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Cut Rear</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_rear_off" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_rear_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Cut Direcionador de Trânsito</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_dt_off" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Acender Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_dt_on" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Cut Horn Light</h3>
                            <div class="function-table-container">
                                <table class="function-table">
                                    <thead><tr><th>Instrução</th><script>for(let i=1; i<=24; i++) document.write(`<th>${i}</th>`);</script></tr></thead>
                                    <tbody><tr><td>Apagar Blocos</td><script>for(let i=1; i<=24; i++) document.write(`<td contenteditable="true" data-function="cut_horn_light" data-block="${i}"></td>`);</script></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Número de FP principais</h3>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label" style="text-transform: none;">Informe quantos FP poderão ser usados para SL1-4 e Aux1-5 >></label>
                                <select class="form-select" id="config-num-fp-principais">
                                    <script>for(let i=1; i<=15; i++) document.write(`<option value="${i}" ${i === 4 ? 'selected' : ''}>${i}</option>`);</script>
                                </select>
                                <span class="fp-setting-description">Quantidade de FP Principais precisa ser preenchido quando utilizar FP de Horn. Default = 4</span>
                            </div>
                        </div>
                        <div class="function-group">
                            <h3 class="function-group-title">Quantidade de FP para DS</h3>
                            <div class="form-group">
                                <label class="form-label" style="text-transform: none;">Informe quantos FP poderão ser usados para DS >></label>
                                <select class="form-select" id="config-qtd-fp-ds">
                                    <script>for(let i=1; i<=15; i++) document.write(`<option value="${i}" ${i === 8 ? 'selected' : ''}>${i}</option>`);</script>
                                </select>
                                <span class="fp-setting-description" style="font-style: normal;">&lt;&lt;O número deve ser multiplo de 4 pois servirá para DR, DL, DC e Hazard. <em>Quantidade de FP para DS precisa ser preenchido quando utilizar FP de Horn. Default = 8</em></span>
                            </div>
                        </div>
                    </div>
                    <div id="tab-jumptabela" class="modal-tab-content">
                        <p class="description">Configure o comportamento global do sistema através dos bits da JumpTabela. Marque as caixas para ativar cada função (equivalente a colocar o valor "1").</p>
                        <div class="jumptabela-section">
                            <h4 class="function-title">JumpTabela #1 - Configurações Gerais</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="7"> b7 >> Ativa o modo fio nos moldes da PCESP</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="6"> b6 >> Remove PWM nos canais 21 e 24 para usar Bloco de LED ou RELÉ</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="5"> b5 >> Define que o MB funciona em sincronismo com outras MB e/ou Auxiliares</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="4"> b4 >> Aciona a saída Alley-Left sem espera do sincronismo com o dimmer da BARRA</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="3"> b3 >> Ignora Fotodiodo (Noite/Dia)</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="2"> b2 >> Apaga todos os módulos enquanto aguarda o Sincronismo</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="1" data-bit="1"> b1 >> Remove PWM em todos os canais da MB para usar sinalizadores auxiliares</label>
                            </div>
                        </div>
                        <div class="jumptabela-section">
                            <h4 class="function-title">JumpTabela #2 - Gerenciamento de Energia e Entradas</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="7"> b7 >> PWM Global de 75% (CONASP)</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="6"> b6 >> PWM Global de 50% (CONASP)</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="5"> b5 >> LOW BATTERY Management (desliga sistema com Vbat&lt;11.8V)</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="4"> b4 >> IN3 = Entrada de acionamento rápido para luz de Horn</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="3"> b3 >> IN4 = Entrada de acionamento dos módulos em modo Background</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="2"> b2 >> Ativa Troca de FP pelos pinos (alguns 6 segundos)</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="2" data-bit="1"> b1 >> Apaga TODOS os módulos enquanto aguarda o Sincronismo</label>
                            </div>
                        </div>
                        <div class="jumptabela-section">
                            <h4 class="function-title">JumpTabela #3 - Modo Master e Tensão</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="3" data-bit="7"> b7 >> Ativa entradas com apenas 9 Volts</label>
                                <label class="checkbox-item"><input type="checkbox" data-jumptabela="3" data-bit="6"> b6 >> MB = Master, não para / apaga pelo Sync</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="save-advanced-settings-btn" style="background-color: #27ae60;">Salvar Definições</button>
            </div>
        </div>
    </div>
    <div id="config-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><div class="panel-title" style="margin-bottom: 0; border-bottom: none;">Dados de Configuração</div><button class="close-button" id="close-modal-btn">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Configuração de Barra</label><input type="text" class="config-input" id="config-barra" value="FLASH STD"></div>
                <div class="form-group"><label class="form-label">Modelo da Barra</label><input type="text" class="config-input" id="modelo-barra" value="Linha S-Slim"></div>
                <div class="form-group"><label class="form-label">Sub-família</label><input type="text" class="config-input" id="sub-familia" value="S-SLIM Bicolor"></div>
                <div class="form-group"><label class="form-label">Tamanho da Barra</label><input type="text" class="config-input" id="tamanho-barra" value="1200mm"></div>
            </div>
            <div class="modal-footer"><button class="btn" id="save-and-close-modal-btn">Salvar e Fechar</button></div>
        </div>
    </div>
    <div class="header"><img src="https://www3.facens.br/maratona/img/patrocinio-2022/Logo_Flash.png" alt="FLASH" class="logo" style="width: 170px; height: auto;"></div>
    <div class="navbar"><div class="nav-item">Menu</div><div class="nav-item">Registrar Usuário</div><div class="nav-item">Contato Engenharia</div><div class="nav-item">Montar Kit</div><a href="view_simulations.php" class="nav-item" style="text-decoration: none;">Ver Simulações Salvas</a></div>

    <div class="main-container">
        <div class="panel left-panel">
            <div class="panel-title">Controle de Macro</div>
            <p class="instruction-text">Clique com o botão direito no número da coluna (1-24) para definir uma cor fixa para o canal.</p>
            <div id="sheet-selector-container" class="sheet-selector-container"></div>
            <div class="excel-container">
                <div class="excel-toolbar">
                    <button id="gravar-btn" class="btn" style="background-color: #c40303; font-size: 10px; padding: 3px 8px;">Gravar</button>
                    <button id="import-txt-btn" class="btn" style="background-color: #9b59b6; font-size: 10px; padding: 3px 8px;"><i class="fa fa-upload"></i> Importar TXT</button>
                    <button id="extract-excel-layout-btn" class="btn" style="background-color: #16a085; font-size: 10px; padding: 3px 8px;">
                        <i class="fa fa-file-excel"></i> Extrair Layout Excel
                    </button>
                    <input type="file" id="excel-layout-input" style="display: none;" accept=".xlsx, .xlsm">
                    <button id="export-gif-btn" class="btn" style="background-color: #1abc9c; font-size: 10px; padding: 3px 8px;"><i class="fa fa-file-image"></i> Exportar GIFs</button>
                    <button id="restaurar-btn" class="btn" style="background-color: #2ecc71; font-size: 10px; padding: 3px 8px;">Restaurar</button>
                    <button id="limpa-btn" class="btn" style="background-color: #f39c12; font-size: 10px; padding: 3px 8px;">Limpar Planilha</button>
                    <button id="advanced-settings-btn" class="btn" style="background-color: #34495e; font-size: 10px; padding: 3px 8px; margin-left: 15px;">
                        <i class="fa fa-cogs"></i> Definições
                    </button>
                </div>
                <div class="excel-grid">
                    <table class="macro-table">
                        <thead id="macro-header"></thead>
                        <tbody id="macro-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="macro-controls">
                <button class="btn" id="execute-macro-btn">Executar Macro</button>
            </div>
        </div>
        
        <div class="right-panel-container">
            <div class="center-panel">
                <div style="width:100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <div class="panel-title" style="border-bottom: none; margin-bottom: 0;">
                        Simulação: <span id="current-layout-name" style="font-weight: 500;"></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                       <button id="open-layout-panel-btn" class="btn" style="background-color: #16a085; font-size:10px; padding: 4px 8px;">
                            <i class="fa fa-th"></i> Selecionar Modelo
                        </button>
                        <button id="edit-layout-btn" class="btn" style="background-color: #3498db; font-size:10px; padding: 4px 8px;">
                            <i class="fa fa-pencil"></i> Editar Layout
                        </button>
                    </div>
                </div>
                <div class="simulation-area" id="simulation-area">
                    <img src="" alt="Modelo da Sirene" id="siren-model-image">
                    <div id="blocks-container"></div>
                </div>
            </div>
            <div class="right-panel">
                <div class="panel-title">Resultado da Configuração</div>
                <div class="config-image-container" style="position: relative; width: 100%; max-width: 500px; margin: 15px auto;">
                    <img src="Imagemcontrole.png" alt="Controle da Barra" style="width: 100%; height: auto; display: block; border-radius: 15px; opacity: 0.5;">
                    <button onclick="triggerMacro('FP1')" style="position: absolute; top: 20%; left: 16%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">FP1</button>
                    <button onclick="triggerMacro('FP3')" style="position: absolute; top: 20%; left: 42.5%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">FP3</button>
                    <button onclick="triggerMacro('FP2')" style="position: absolute; top: 20%; left: 69%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">FP2</button>
                    <button id="btn-le" onclick="toggleSpecialFunction('alley_left')" class="control-btn" style="position: absolute; top: 26%; left: 6%; width: 6%; height: 50%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">LE</button>
                    <button id="btn-ld" onclick="toggleSpecialFunction('alley_right')" class="control-btn" style="position: absolute; top: 26%; left: 88%; width: 6%; height: 50%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">LD</button>
                    <button id="btn-td" onclick="toggleSpecialFunction('takedown')" class="control-btn" style="position: absolute; top: 51%; left: 42.5%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">TD</button>
                    <button onclick="triggerMacro('EM1')" style="position: absolute; top: 69%; left: 15.4%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">EM1</button>
                    <button onclick="triggerMacro('HZD')" style="position: absolute; top: 69%; left: 70%; width: 15%; height: 12%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">HZD</button>
                    <button onclick="triggerMacro('DS-L')" style="position: absolute; top: 70%; left: 33%; width: 10%; height: 10%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">«</button>
                    <button onclick="triggerMacro('DS-C')" style="position: absolute; top: 75%; left: 45%; width: 10%; height: 10%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">«»</button>
                    <button onclick="triggerMacro('DS-R')" style="position: absolute; top: 70%; left: 57%; width: 10%; height: 10%; background-color: #e9ecef; border: 1px solid #555; cursor: pointer; border-radius: 5px; color: #000; font-weight: bold; font-size: 1vw; display: flex; align-items: center; justify-content: center;">»</button>
                </div>
                <div class="output-item" id="special-functions-status-output">
                    <div class="output-label">Funções Especiais Ativas</div>
                    <div id="special-functions-active-list" class="status-panel-list">
                        <p class="no-settings">Nenhuma função especial ativa.</p>
                    </div>
                </div>
                <div class="output-item" id="jumptabela-status-output">
                    <div class="output-label">Configurações Globais Ativas (JumpTabela)</div>
                    <div id="jumptabela-active-list" class="status-panel-list">
                        <p class="no-settings">Nenhuma configuração global ativa.</p>
                    </div>
                </div>
                <div class="output-item" style="background-color: #e9ecef;">
                    <div class="output-label" style="color: #2c3e50; font-weight: 700;">CONSUMO DO MÓDULO</div>
                    <div style="display: flex; justify-content: space-around; margin-top: 5px;">
                        <div style="text-align:center;">
                            <div class="output-label">MÉDIA FINAL</div>
                            <div class="output-value" id="output-media-final" style="font-size: 14px; font-weight: bold; color: #0070c0;">0,000 A</div>
                        </div>
                        <div style="text-align:center;">
                            <div class="output-label">PICO</div>
                            <div class="output-value" id="output-pico" style="font-size: 14px; font-weight: bold; color: #dc3545;">0,000 A</div>
                        </div>
                    </div>
                </div>
                <button class="btn" id="edit-config-btn" style="width: 100%; margin-top: 10px;">Editar Configuração</button>
            </div>
        </div>
    </div>

    <script>
        // --- CÓDIGO JAVASCRIPT COMPLETO ---

        // === REFERÊNCIAS DE ELEMENTOS DO DOM ===
        let configModal, openModalBtn, closeModalBtn, saveAndCloseModalBtn, executeMacroBtn, blocksContainer, macroTableBody, macroHeader, sheetSelectorContainer, gravarBtn, restaurarBtn, limpaBtn, colorContextMenu, layoutPanelModal, openLayoutPanelBtn, closeLayoutPanelBtn, layoutPanelBody, currentLayoutNameSpan, advancedSettingsModal, openAdvancedSettingsBtn, closeAdvancedSettingsBtn, saveAdvancedSettingsBtn, tabButtons, tabContents, jumpTabelaCheckboxes, specialFunctionCells, jumpTabelaStatusContainer, specialFunctionsStatusContainer;

        // === GERENCIAMENTO DE ESTADO ===
        let simulationStopper = null;
        let isSimulationRunning = false;
        const sheetNames = ['FP1','FP2', 'FP3', 'FP4', 'AUX1', 'AUX2', 'AUX3', 'AUX4', 'DS-L', 'DS-C', 'DS-R', 'HZD', 'EM1'];
        let allMacroData = {};
        let activeSheet = 'FP1';
        let savedSpecialFunctionConfigs = {};
        let savedJumpTabelaSettings = {};
        let columnColors = {};
        let clipboardData = null;
        let copiedBlockData = null; 
        let isEditMode = false;
        let activeBlock = null;
        let action = null; 
        let activeSpecialFunctions = {};
        const selection = new Set();
        let undoHistory = {};
        let redoHistory = {};
        let debounceTimer;
        let gifWorkerBlobURL = null;
        let backgroundImageDataURL = null;
        let currentLayout;
        let activeBlockLayout; 
        
        // ================================================================================= //
        // ======================= MAPA DE CÓDIGOS DE ARQUIVO PARA LAYOUT ====================== //
        // ================================================================================= //
        const fileCodeToLayoutMap = {
            "00179": "primus47p18mCol", "00180": "primus47p20mRef", "00181": "primus40p18mCol",
            "00182": "primus47p20mRef", "00183": "primus47p20mRef", "00184": "primus47p20mRef",
            "00185": "primus47p20mRef", "00186": "venus11m", "00187": "primus47p20mRef",
            "00188": "primus47p20mRef", "00189": "primus47p18mRef", "00190": "primus47p20mRef",
            "00191": "venus14m", "00193": "venus24m", "00194": "primus47p24mRef", "00195": "venus14m",
            "00196": "primus61p24mRef", "00197": "primus47p13mRef", "00198": "venus22m", "00199": "primus54p22mRef",
            "00200": "primus47p11mCol", "00201": "primus47p16mCol", "00202": "primus47p18mRef",
            "00203": "primus47p16mRef", "00204": "primus47p20mRef", "00205": "primus47p21mRef",
            "00207": "primus47p20mRef", "00208": "primus47p22mRef", "00209": "primus47p22mRef",
            "00210": "primus47p24mRef", "00211": "primus40p18mRef", "00212": "primus54p18mCol",
            "00213": "primus47p20mRef", "00214": "primus47p16mCol", "00215": "primus54p22mRef",
            "00216": "primus47p16mCol", "00217": "venus15m", "00218": "primus47p16mCol",
            "00219": "primus47p20mCol", "00220": "primus40p18mRef", "00221": "primus47p20mRef",
            "00222": "venus15m", "00223": "primus47p20mRef", "00224": "primus47p20mRef",
            "00225": "primus47p16mCol", "00226": "venus15m", "00227": "primus40p14mCol",
            "00228": "primus47p16mRef", "00229": "primus54p22mRef", "00232": "venus15m",
            "00233": "primus47p20mRef", "00234": "primus47p24mCol", "00235": "primus47p13mRef",
        };
        
        const s_slim_bicolor_example = [
            { text: ['1', '2'], top: '45%', left: '30%', width: 77, height: 30, rotate: 0 }, 
            { text: ['3', '4'], top: '45%', left: '40%', width: 77, height: 30, rotate: 0 },
            { text: '20', top: '14.6%', left: '10%', width: 77, height: 30, rotate: 0 },
            { text: '20', top: '14.6%', left: '80%', width: 77, height: 30, rotate: 0 }
        ];

        const s_slim_24_default_BlockLayout = [
            { text: '1', top: '14.6%', left: '45.9%', width: 77, height: 30, rotate: 0 }, { text: '2', top: '14.6%', left: '58.5%', width: 77, height: 30, rotate: 0 },
            { text: '3', top: '14.6%', left: '67.7%', width: 77, height: 30, rotate: 0 }, { text: '4', top: '14.6%', left: '77%', width: 77, height: 30, rotate: 0 },
            { text: '5', top: '20%', left: '86%', width: 79, height: 31, rotate: 35 }, { text: '6', top: '44.9%', left: '91%', width: 82, height: 31, rotate: 90 },
            { text: '7', top: '70%', left: '86%', width: 79, height: 31, rotate:-35 }, { text: '8', top: '76.4%', left: '77%', width: 77, height: 30, rotate: 0 },
            { text: '9', top: '76.4%', left: '67.7%', width: 77, height: 30, rotate: 0 }, { text: '10', top: '76.4%', left: '58.4%', width: 77, height: 30, rotate: 0 },
            { text: '11', top: '76.5%', left: '45.9%', width: 77, height: 30, rotate: 0 }, { text: '12', top: '76.5%', left: '33.3%', width: 77, height: 30, rotate: 0 },
            { text: '13', top: '76.5%', left: '24.1%', width: 77, height: 30, rotate: 0 }, { text: '14', top: '76.5%', left: '14.8%', width: 77, height: 30, rotate: 0 },
            { text: '15', top: '70%', left: '5.6%', width: 79, height: 30, rotate: 35 }, { text: '16', top: '45%', left: '0.5%', width: 80, height: 30, rotate: 90 },
            { text: '17', top: '20%', left: '5.5%', width: 79, height: 30, rotate: -35 }, { text: '18', top: '14.6%', left: '14.7%', width: 77, height: 30, rotate: 0 },
            { text: '19', top: '14.6%', left: '24.1%', width: 77, height: 30, rotate: 0 }, { text: '20', top: '14.6%', left: '33.3%', width: 77, height: 30, rotate: 0 },
            { text: '21', top: '45%', left: '33.3%', width: 77, height: 30, rotate: 0 }, { text: '22', top: '45%', left: '45.9%', width: 77, height: 30, rotate: 0 },
            { text: '23', top: '45%', left: '58.5%', width: 77, height: 30, rotate: 0 }, { text: '24', top: '45%', left: '77%', width: 77, height: 30, rotate: 0 }
        ];

        const layouts = [
            { id: 's_slim_24_default', name: 'S-SLIM 24m Padrão', image: 'simulação.png', category: 'Padrão', blocks: s_slim_24_default_BlockLayout },
            { id: 's_slim_bicolor_example', name: 'S-SLIM Bicolor Exemplo', image: 'simulação.png', category: 'Padrão', blocks: s_slim_bicolor_example },
            
            // 40 Polegadas
            { id: 'primus40p12mCol', name: 'Primus 40p 12m Col', image: 'ImagensSirene40p/primus40p12mCol.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p12mRef', name: 'Primus 40p 12m Ref', image: 'ImagensSirene40p/primus40p12mRef.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p14mCol', name: 'Primus 40p 14m Col', image: 'ImagensSirene40p/primus40p14mCol.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p14mRef', name: 'Primus 40p 14m Ref', image: 'ImagensSirene40p/primus40p14mRef.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p16mCol', name: 'Primus 40p 16m Col', image: 'ImagensSirene40p/primus40p16mCol.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p16mRef', name: 'Primus 40p 16m Ref', image: 'ImagensSirene40p/primus40p16mRef.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p18mCol', name: 'Primus 40p 18m Col', image: 'ImagensSirene40p/primus40p18mCol.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p18mRef', name: 'Primus 40p 18m Ref', image: 'ImagensSirene40p/primus40p18mRef.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus40p22mRef', name: 'Primus 40p 22m Ref', image: 'ImagensSirene40p/primus40p22mRef.png', category: '40 Polegadas', blocks: s_slim_24_default_BlockLayout },

            // 47 Polegadas
            { id: 'primus47p11mCol', name: 'Primus 47p 11m Col', image: 'ImagensRefletor47p/colimador/primus47p11mCol.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p11mRef', name: 'Primus 47p 11m Ref', image: 'ImagensRefletor47p/refletor/primus47p11mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p13mRef', name: 'Primus 47p 13m Ref', image: 'ImagensRefletor47p/refletor/primus47p13mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p14mCol', name: 'Primus 47p 14m Col', image: 'ImagensRefletor47p/colimador/primus47p14mCol.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p14mRef', name: 'Primus 47p 14m Ref', image: 'ImagensRefletor47p/refletor/primus47p14mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p16mCol', name: 'Primus 47p 16m Col', image: 'ImagensRefletor47p/colimador/primus47p16mCol.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p16mRef', name: 'Primus 47p 16m Ref', image: 'ImagensRefletor47p/refletor/primus47p16mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p18mRef', name: 'Primus 47p 18m Ref', image: 'ImagensRefletor47p/refletor/primus47p18mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p20mCol', name: 'Primus 47p 20m Col', image: 'ImagensRefletor47p/colimador/primus47p20mCol.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p20mRef', name: 'Primus 47p 20m Ref', image: 'ImagensRefletor47p/refletor/primus47p20mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p22mRef', name: 'Primus 47p 22m Ref', image: 'ImagensRefletor47p/refletor/primus47p22mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus47p24mRef', name: 'Primus 47p 24m Ref', image: 'ImagensRefletor47p/refletor/primus47p24mRef.png', category: '47 Polegadas', blocks: s_slim_24_default_BlockLayout },
            
            // 54 Polegadas
            { id: 'primus54p10mCol', name: 'Primus 54p 10m Col', image: 'ImagensSirene54P/colimador/primus54p10mCol.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p12mRef', name: 'Primus 54p 12m Ref', image: 'ImagensSirene54P/refletor/primus54p12mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p14mCol', name: 'Primus 54p 14m Col', image: 'ImagensSirene54P/colimador/primus54p14mCol.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p14mRef', name: 'Primus 54p 14m Ref', image: 'ImagensSirene54P/refletor/primus54p14mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p16mCol', name: 'Primus 54p 16m Col', image: 'ImagensSirene54P/colimador/primus54p16mCol.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p18mRef', name: 'Primus 54p 18m Ref', image: 'ImagensSirene54P/refletor/primus54p18mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p20mRef', name: 'Primus 54p 20m Ref', image: 'ImagensSirene54P/refletor/primus54p20mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p22mCol', name: 'Primus 54p 22m Col', image: 'ImagensSirene54P/colimador/primus54p22mCol.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p22mRef', name: 'Primus 54p 22m Ref', image: 'ImagensSirene54P/refletor/primus54p22mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus54p26mRef', name: 'Primus 54p 26m Ref', image: 'ImagensSirene54P/refletor/primus54p26mRef.png', category: '54 Polegadas', blocks: s_slim_24_default_BlockLayout },
            
            // 61 Polegadas
            { id: 'primus61p13mCol', name: 'Primus 61p 13m Col', image: 'ImagensSirene61P/colimador/primus61p13mCol.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p13mRef', name: 'Primus 61p 13m Ref', image: 'ImagensSirene61P/refletor/primus61p13mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p14mCol', name: 'Primus 61p 14m Col', image: 'ImagensSirene61P/colimador/primus61p14mCol.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p15mRef', name: 'Primus 61p 15m Ref', image: 'ImagensSirene61P/refletor/primus61p15mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p18mCol', name: 'Primus 61p 18m Col', image: 'ImagensSirene61P/colimador/primus61p18mCol.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p18mRef', name: 'Primus 61p 18m Ref', image: 'ImagensSirene61P/refletor/primus61p18mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p20mRef', name: 'Primus 61p 20m Ref', image: 'ImagensSirene61P/refletor/primus61p20mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p22mRef', name: 'Primus 61p 22m Ref', image: 'ImagensSirene61P/refletor/primus61p22mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p24mCol', name: 'Primus 61p 24m Col', image: 'ImagensSirene61P/colimador/primus61p24mCol.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p24mRef', name: 'Primus 61p 24m Ref', image: 'ImagensSirene61P/refletor/primus61p24mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            { id: 'primus61p28mRef', name: 'Primus 61p 28m Ref', image: 'ImagensSirene61P/refletor/primus61p28mRef.png', category: '61 Polegadas', blocks: s_slim_24_default_BlockLayout },
            
            // Venus
            { id: 'venus11m', name: 'Venus 11m', image: 'VenusSirene/venus11m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus14m', name: 'Venus 14m', image: 'VenusSirene/venus14m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus15m', name: 'Venus 15m', image: 'VenusSirene/venus15m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus16m', name: 'Venus 16m', image: 'VenusSirene/venus16m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus19m', name: 'Venus 19m', image: 'VenusSirene/venus19m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus20m', name: 'Venus 20m', image: 'VenusSirene/venus20m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus22m', name: 'Venus 22m', image: 'VenusSirene/venus22m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
            { id: 'venus24m', name: 'Venus 24m', image: 'VenusSirene/venus24m.png', category: 'Venus', blocks: s_slim_24_default_BlockLayout },
        ];


        const baseSheetStructure = Array.from({ length: 200 }, (_, i) => ({
            row: i + 1,
            ms: '0',
            values: Array(24).fill('')
        }));
        
        // ================================================================================= //
        // =================== FIM DA LÓGICA DE LAYOUT DE BLOCOS =========================== //
        // ================================================================================= //
        
        // === FUNÇÕES DE INICIALIZAÇÃO E LAYOUT ===
        function initializeApp() {
            assignDomElements();
            initializeDataStructure();
            createSheetSelectorTabs();
            createTableHeader();
            populateLayoutPanel();
            switchLayout(layouts[0].id); 
            renderTable(allMacroData[activeSheet]);
            updateActiveSheetUI();
            initializeEventListeners();
            initializeInteractionHandlers();
            renderAllActiveSettings(); 
            updateConsumptionDisplay();
        }

        function assignDomElements() {
            configModal = document.getElementById('config-modal');
            openModalBtn = document.getElementById('edit-config-btn');
            closeModalBtn = document.getElementById('close-modal-btn');
            saveAndCloseModalBtn = document.getElementById('save-and-close-modal-btn');
            executeMacroBtn = document.getElementById('execute-macro-btn');
            blocksContainer = document.getElementById('blocks-container');
            macroTableBody = document.getElementById('macro-body');
            macroHeader = document.getElementById('macro-header');
            sheetSelectorContainer = document.getElementById('sheet-selector-container');
            gravarBtn = document.getElementById('gravar-btn');
            restaurarBtn = document.getElementById('restaurar-btn');
            limpaBtn = document.getElementById('limpa-btn');
            colorContextMenu = document.getElementById('color-context-menu');
            layoutPanelModal = document.getElementById('layout-panel-modal');
            openLayoutPanelBtn = document.getElementById('open-layout-panel-btn');
            closeLayoutPanelBtn = document.getElementById('close-layout-panel-btn');
            layoutPanelBody = document.getElementById('layout-panel-body');
            currentLayoutNameSpan = document.getElementById('current-layout-name');
            advancedSettingsModal = document.getElementById('advanced-settings-modal');
            openAdvancedSettingsBtn = document.getElementById('advanced-settings-btn');
            closeAdvancedSettingsBtn = document.getElementById('close-advanced-modal-btn');
            saveAdvancedSettingsBtn = document.getElementById('save-advanced-settings-btn');
            tabButtons = document.querySelectorAll('.modal-tab-btn');
            tabContents = document.querySelectorAll('.modal-tab-content');
            jumpTabelaCheckboxes = document.querySelectorAll('#tab-jumptabela input[type="checkbox"]');
            specialFunctionCells = document.querySelectorAll('#tab-special-functions td[data-block]');
            jumpTabelaStatusContainer = document.getElementById('jumptabela-active-list');
            specialFunctionsStatusContainer = document.getElementById('special-functions-active-list');
            simulationArea = document.getElementById('simulation-area');
            saveLayoutBtn = document.getElementById('save-layout-btn');
        }

        async function populateLayoutPanel() {
            layoutPanelBody.innerHTML = 'Carregando layouts...';
            let allLayouts = [...layouts]; // Começa com a lista de layouts padrão

            try {
                const response = await fetch('api/carregar_layouts.php');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const customLayouts = await response.json();

                // Adiciona os layouts do banco de dados à lista
                customLayouts.forEach(custom => {
                    allLayouts.push({
                        id: `custom-${custom.layout_id}`, // ID único para evitar conflitos
                        name: custom.nome_layout,
                        image: custom.imagem_base,
                        category: 'Layouts Personalizados',
                        blocks: custom.dados_layout 
                    });
                });
            } catch (error) {
                console.error("Erro ao carregar layouts personalizados:", error);
            }
            
            renderLayoutGrid(allLayouts);
        }

        function renderLayoutGrid(layoutsToRender) {
            const layoutGroups = layoutsToRender.reduce((groups, layout) => {
                const category = layout.category || 'Outros Modelos';
                if (!groups[category]) groups[category] = [];
                groups[category].push(layout);
                return groups;
            }, {});
            
            const categoryOrder = ['Padrão', 'Layouts Personalizados', '40 Polegadas', '47 Polegadas', '54 Polegadas', '61 Polegadas', 'Venus', 'Outros Modelos'];
            const gridContainer = document.createElement('div');
            gridContainer.className = 'layout-panel-grid';
            
            categoryOrder.forEach(categoryName => {
                if (layoutGroups[categoryName]) {
                    const title = document.createElement('h3');
                    title.className = 'layout-category-title';
                    title.textContent = categoryName;
                    gridContainer.appendChild(title);
                    
                    layoutGroups[categoryName].forEach(layout => {
                        const item = document.createElement('div');
                        item.className = 'layout-preview-item';
                        item.dataset.layoutId = layout.id;
                        item.innerHTML = `<img src="${layout.image}" alt="${layout.name}"><p>${layout.name}</p>`;
                        item.addEventListener('click', () => {
                            switchLayout(layout.id, layoutsToRender); 
                            layoutPanelModal.style.display = 'none';
                        });
                        gridContainer.appendChild(item);
                    });
                }
            });
            layoutPanelBody.innerHTML = '';
            layoutPanelBody.appendChild(gridContainer);
        }

        function switchLayout(layoutId, allLayoutsList = layouts) {
            const selectedLayout = allLayoutsList.find(l => l.id === layoutId);
            if (!selectedLayout) {
                console.error("Layout não encontrado:", layoutId);
                return;
            }
            currentLayout = selectedLayout;
            activeBlockLayout = JSON.parse(JSON.stringify(selectedLayout.blocks)); 
            currentLayoutNameSpan.textContent = currentLayout.name;
            document.getElementById('siren-model-image').src = currentLayout.image;
            initializeBlocks(activeBlockLayout);
            stopSimulation();
        }
        
        function initializeDataStructure() {
            sheetNames.forEach(name => {
                allMacroData[name] = JSON.parse(JSON.stringify(baseSheetStructure));
                undoHistory[name] = [];
                redoHistory[name] = [];
            });
            columnColors = {};
        }

        function initializeBlocks(blocksArray) {
            blocksContainer.innerHTML = '';
            if (!blocksArray) return;

            blocksArray.forEach((blockData, index) => {
                const blockElement = document.createElement('div');
                blockElement.className = 'block-container';
                blockElement.dataset.index = index;
                blockElement.style.top = blockData.top;
                blockElement.style.left = blockData.left;
                blockElement.style.width = `${blockData.width}px`;
                blockElement.style.height = `${blockData.height}px`;
                blockElement.style.transform = `rotate(${blockData.rotate}deg)`;

                if (Array.isArray(blockData.text)) { // Bloco dividido (Bicolor)
                    const container = document.createElement('div');
                    container.className = 'block-part-container';
                    
                    const topPart = document.createElement('div');
                    topPart.className = 'block-part-top layout-color-off';
                    topPart.textContent = blockData.text[0];
                    topPart.dataset.blockNum = blockData.text[0];
                    
                    const bottomPart = document.createElement('div');
                    bottomPart.className = 'block-part-bottom layout-color-off';
                    bottomPart.textContent = blockData.text[1];
                    bottomPart.dataset.blockNum = blockData.text[1];
                    
                    container.appendChild(topPart);
                    container.appendChild(bottomPart);
                    blockElement.appendChild(container);
                } else { // Bloco único
                    const singlePart = document.createElement('div');
                    singlePart.className = 'block-part-single layout-color-off';
                    singlePart.textContent = blockData.text;
                    singlePart.dataset.blockNum = blockData.text;
                    
                    singlePart.addEventListener('dblclick', (e) => {
                        if (isEditMode) {
                            e.stopPropagation();
                            singlePart.contentEditable = true;
                            singlePart.focus();
                        }
                    });
                    singlePart.addEventListener('blur', () => {
                        singlePart.contentEditable = false;
                        activeBlockLayout[index].text = singlePart.textContent;
                    });
                     singlePart.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            singlePart.blur();
                        }
                    });

                    blockElement.appendChild(singlePart);
                }

                blockElement.innerHTML += `<div class="interaction-handle resize-handle"></div><div class="interaction-handle rotate-handle"></div>`;
                blocksContainer.appendChild(blockElement);
            });
        }
        
        function loadDataIntoUI(loadedData) {
            if (loadedData.layout_id) {
                const foundLayout = layouts.find(l => l.id === loadedData.layout_id);
                if (foundLayout) {
                    switchLayout(loadedData.layout_id);
                } else {
                    console.warn(`Layout com ID "${loadedData.layout_id}" não encontrado. Usando o padrão.`);
                    switchLayout(layouts[0].id);
                }
            }

            if (loadedData.block_layout) {
                activeBlockLayout = loadedData.block_layout;
                if (currentLayout) {
                    currentLayout.blocks = JSON.parse(JSON.stringify(activeBlockLayout));
                }
                initializeBlocks(activeBlockLayout);
            }

            allMacroData = loadedData.data || {};
            sheetNames.forEach(name => {
                if (!allMacroData[name]) {
                    allMacroData[name] = JSON.parse(JSON.stringify(baseSheetStructure));
                }
            });
            savedSpecialFunctionConfigs = loadedData.special_functions || {};
            savedJumpTabelaSettings = loadedData.jumptabela_settings || {};
            columnColors = loadedData.column_colors || {};
            
            specialFunctionCells.forEach(cell => {
                const func = cell.dataset.function;
                const block = parseInt(cell.dataset.block, 10);
                cell.textContent = savedSpecialFunctionConfigs[func]?.includes(block) ? '1' : '';
            });
            jumpTabelaCheckboxes.forEach(checkbox => {
                const key = `jt${checkbox.dataset.jumptabela}_bit${checkbox.dataset.bit}`;
                checkbox.checked = !!savedJumpTabelaSettings[key];
            });
            activeSheet = 'FP1';
            renderTable(allMacroData[activeSheet]);
            updateActiveSheetUI();
            updateAllVisuals();
            renderAllActiveSettings();
            updateConsumptionDisplay();
            alert('Template carregado com sucesso!');
        }
                                
        function pushStateToUndoHistory() {
            const currentData = getCurrentTableData();
            const lastState = undoHistory[activeSheet][undoHistory[activeSheet].length - 1];
            if (lastState && JSON.stringify(lastState) === JSON.stringify(currentData)) { return; }
            undoHistory[activeSheet].push(JSON.parse(JSON.stringify(currentData)));
            redoHistory[activeSheet] = [];
        }
        
        const debouncedPushState = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { pushStateToUndoHistory(); }, 500);
        };
        
        function createSheetSelectorTabs() {
            sheetSelectorContainer.innerHTML = '';
            sheetNames.forEach(name => {
                const button = document.createElement('button');
                button.className = 'sheet-selector-btn';
                button.dataset.sheet = name;
                button.textContent = name;
                sheetSelectorContainer.appendChild(button);
            });
        }
        
        function createTableHeader() {
            macroHeader.innerHTML = '';
            const tr = document.createElement('tr');
            tr.innerHTML += `<th class="column-header">ms/25</th><th class="column-header">ms</th><th class="column-header">#</th>`;
            for (let i = 1; i <= 24; i++) { 
                tr.innerHTML += `<th class="column-header" data-col-index="${i - 1}" title="Clique com o botão direito para definir uma cor fixa para este canal.">${i}</th>`; 
            }
            macroHeader.appendChild(tr);
        }
        
        function renderTable(data) {
            macroTableBody.innerHTML = '';
            const tableData = data || JSON.parse(JSON.stringify(baseSheetStructure));
            tableData.forEach((rowData) => {
                const tr = document.createElement('tr');
                const ms25Cell = document.createElement('td');
                ms25Cell.className = 'ms25-column';
                ms25Cell.contentEditable = true;
                const msValue = parseInt(rowData.ms, 10);
                ms25Cell.textContent = isNaN(msValue) || rowData.ms === '' ? '' : (msValue === 0 ? '0' : Math.round(msValue / 25));
                tr.appendChild(ms25Cell);
                const msCell = document.createElement('td');
                msCell.className = 'ms-column';
                msCell.textContent = rowData.ms;
                msCell.contentEditable = true;
                tr.appendChild(msCell);
                const counterCell = document.createElement('td');
                counterCell.className = 'row-counter-column';
                counterCell.textContent = rowData.row;
                tr.appendChild(counterCell);
                ms25Cell.addEventListener('input', () => syncTimeValues(ms25Cell, msCell, 'from_ms25'));
                msCell.addEventListener('input', () => syncTimeValues(ms25Cell, msCell, 'from_ms'));
                const dataValues = rowData.values || [];
                for (let i = 0; i < 24; i++) { createEditableCell(tr, dataValues[i] || '', i); }
                macroTableBody.appendChild(tr);
            });
            applyAllColumnColors();
        }
        
        function syncTimeValues(ms25Cell, msCell, source) {
            if (source === 'from_ms25') {
                const val = parseInt(ms25Cell.textContent, 10);
                msCell.textContent = isNaN(val) ? '' : val * 25;
            } else {
                const val = parseInt(msCell.textContent, 10);
                ms25Cell.textContent = isNaN(val) ? '' : Math.round(val / 25);
            }
        }

        function createEditableCell(parent, value, colIndex) {
            const td = document.createElement('td');
            td.className = 'editable-cell';
            td.contentEditable = true;
            td.dataset.colIndex = colIndex;
            td.textContent = value;
            updateCellColor(td);
            td.addEventListener('blur', pushStateToUndoHistory);
            td.addEventListener('input', function() {
                const originalText = this.textContent;
                const validChars = originalText.match(/[1-4]/g); 
                const newText = validChars ? validChars[validChars.length - 1] : '';
                if (originalText !== newText) { this.textContent = newText; }
                updateCellColor(this);
                updateConsumptionDisplay();
                debouncedPushState();
            });
            td.addEventListener('focus', function() {
                highlightCurrentRow(this.parentElement.rowIndex - 1);
            });
            parent.appendChild(td);
        }
        
        function updateCellColor(cell) {
            const value = cell.textContent.trim();
            cell.classList.remove('cell-red', 'cell-blue', 'cell-yellow', 'cell-white');
            if (value === '1') cell.classList.add('cell-red');
            else if (value === '2') cell.classList.add('cell-blue');
            else if (value === '3') cell.classList.add('cell-white');
            else if (value === '4') cell.classList.add('cell-yellow');
        }
        
        
        // ========================================================================================//
        // =================== FUNÇÃO PRINCIPAL DE EXTRAÇÃO DO EXCEL (VERSÃO FINAL) ================== //
        // ========================================================================================//
        async function processExcelLayout(file) {
            const START_ROW = 1, END_ROW = 13, START_COL = 0, END_COL = 31;
            const COLOR_MAP = { 'VM': 'red', 'AZ': 'blue', 'BR': 'white', 'AB': 'yellow' };

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error("Erro ao ler o arquivo."));

                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetNames = workbook.SheetNames;

                        let targetSheetName = '';
                        const polSheets = sheetNames.filter(name => name.toUpperCase().includes("POL"));

                        if (polSheets.length > 0) {
                            targetSheetName = polSheets[0]; // Usa a primeira por padrão
                            const filenameMatch = file.name.match(/(\d{2})/);
                            if (filenameMatch) {
                                const identifier = filenameMatch[1];
                                const matchedSheet = polSheets.find(sheet => sheet.includes(identifier));
                                if (matchedSheet) targetSheetName = matchedSheet;
                            }
                        } else {
                            targetSheetName = sheetNames[0];
                            if (!targetSheetName) return reject(new Error("Nenhuma planilha encontrada."));
                        }
                        
                        console.log(`Usando a planilha: '${targetSheetName}'`);
                        const worksheet = workbook.Sheets[targetSheetName];

                        const sheetData = [];
                        for (let r = START_ROW; r <= END_ROW; r++) {
                            const rowData = [];
                            for (let c = START_COL; c <= END_COL; c++) {
                                const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                                const cell = worksheet[cellAddress];
                                rowData.push(cell ? cell.v : null);
                            }
                            sheetData.push(rowData);
                        }
                        
                        (worksheet['!merges'] || []).forEach(merge => {
                            const { s, e } = merge;
                            if (s.r >= START_ROW && s.r <= END_ROW && s.c >= START_COL && s.c <= END_COL) {
                                const value = sheetData[s.r - START_ROW][s.c - START_COL];
                                for (let r = s.r; r <= e.r; r++) {
                                    for (let c = s.c; c <= e.c; c++) {
                                        if (r >= START_ROW && r <= END_ROW && c >= START_COL && c <= END_COL) {
                                            if (sheetData[r - START_ROW]) {
                                                sheetData[r - START_ROW][c - START_COL] = value;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        const numeros = [];
                        const cores = [];
                        
                        sheetData.forEach((row, r_idx) => {
                            (row || []).forEach((cellValue, c_idx) => {
                                if (cellValue === null || cellValue === undefined) return;
                                const cellText = String(cellValue).trim();
                                
                                try {
                                    const num = parseInt(parseFloat(cellText));
                                    if (!isNaN(num) && num >= 1 && num <= 24) {
                                        numeros.push({ value: num, r: r_idx, c: c_idx });
                                        return;
                                    }
                                } catch (e) {}

                                const cellUpper = cellText.toUpperCase();
                                for (const [codigo, nomeCor] of Object.entries(COLOR_MAP)) {
                                    if (cellUpper.includes(codigo)) {
                                        cores.push({ color: nomeCor, r: r_idx, c: c_idx });
                                        break; 
                                    }
                                }
                            });
                        });
                        
                        if (numeros.length === 0) {
                           return reject(new Error("Nenhum módulo numérico (1-24) foi encontrado na planilha."));
                        }
                         if (cores.length === 0) {
                           return reject(new Error("Nenhuma célula com código de cor (VM, AZ, BR, etc.) foi encontrada."));
                        }
                        
                        const layoutAssociado = [];
                        let coresDisponiveis = [...cores];

                        numeros.forEach(num_data => {
                            let melhorCorInfo = null;
                            let distanciaMinima = Infinity;
                            let melhorCorIndex = -1;

                            coresDisponiveis.forEach((cor_data, index) => {
                                const distancia = Math.abs(num_data.r - cor_data.r) + Math.abs(num_data.c - cor_data.c);
                                if (distancia < distanciaMinima) {
                                    distanciaMinima = distancia;
                                    melhorCorInfo = cor_data;
                                    melhorCorIndex = index;
                                }
                            });

                            if (melhorCorInfo) {
                                layoutAssociado.push({
                                    module: num_data.value,
                                    color: melhorCorInfo.color,
                                    r: num_data.r,
                                    c: num_data.c
                                });
                                coresDisponiveis.splice(melhorCorIndex, 1);
                            }
                        });
                        
                        layoutAssociado.sort((a, b) => a.r - b.r || a.c - b.c);

                        const minR = Math.min(...layoutAssociado.map(item => item.r));
                        const maxR = Math.max(...layoutAssociado.map(item => item.r));
                        const minC = Math.min(...layoutAssociado.map(item => item.c));
                        const maxC = Math.max(...layoutAssociado.map(item => item.c));

                        const layoutHeight = (maxR - minR) > 0 ? (maxR - minR) : 1;
                        const layoutWidth = (maxC - minC) > 0 ? (maxC - minC) : 1;

                        const newBlockLayout = layoutAssociado.map(item => {
                            const relativeY = item.r - minR;
                            const relativeX = item.c - minC;
                            
                            const topPercent = (relativeY / layoutHeight) * 80 + 10;
                            const leftPercent = (relativeX / layoutWidth) * 90 + 5;

                            return {
                                text: String(item.module),
                                top: `${topPercent}%`,
                                left: `${leftPercent}%`,
                                width: 60,
                                height: 30,
                                rotate: 0
                            };
                        });

                        resolve({ layout: layoutAssociado, newBlockLayout: newBlockLayout });

                    } catch (error) {
                        console.error("Erro detalhado ao processar Excel:", error);
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function saveLayoutToDatabase() {
            if (!currentLayout) {
                alert("Nenhum layout base selecionado para salvar.");
                return;
            }

            const layoutName = prompt("Digite um nome para este layout personalizado:", currentLayout.name || "Novo Layout");
            if (!layoutName) {
                alert("Salvamento cancelado.");
                return;
            }

            const payload = {
                nome: layoutName,
                imagem: currentLayout.image,
                layout: activeBlockLayout // A variável global com as posições editadas
            };

            try {
                const response = await fetch('api/salvar_layout.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Sucesso! O layout foi salvo no banco de dados.');
                    populateLayoutPanel(); // Atualiza a lista de layouts para incluir o novo
                } else {
                    throw new Error(result.error || 'Erro desconhecido no servidor.');
                }
            } catch (error) {
                console.error('ERRO AO SALVAR LAYOUT:', error);
                alert(`FALHA! Ocorreu um erro ao salvar o layout: ${error.message}`);
            }
        }
        
        function initializeEventListeners() {
            if (openModalBtn) openModalBtn.addEventListener('click', () => configModal.style.display = 'flex');
            if (closeModalBtn) closeModalBtn.addEventListener('click', () => configModal.style.display = 'none');
            if (saveAndCloseModalBtn) saveAndCloseModalBtn.addEventListener('click', () => { configModal.style.display = 'none'; });
            if (openAdvancedSettingsBtn) openAdvancedSettingsBtn.addEventListener('click', () => { clearSelection(); advancedSettingsModal.style.display = 'flex'; });
            if (closeAdvancedSettingsBtn) closeAdvancedSettingsBtn.addEventListener('click', () => advancedSettingsModal.style.display = 'none');
            if (saveAdvancedSettingsBtn) saveAdvancedSettingsBtn.addEventListener('click', saveAdvancedSettings);
            if (openLayoutPanelBtn) openLayoutPanelBtn.addEventListener('click', () => {
                populateLayoutPanel();
                layoutPanelModal.style.display = 'flex';
            });
            if (closeLayoutPanelBtn) closeLayoutPanelBtn.addEventListener('click', () => layoutPanelModal.style.display = 'none');
            if (tabButtons) tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); }); });
            if (jumpTabelaCheckboxes) jumpTabelaCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', updateJumpTabelaVisuals); });
            if (specialFunctionCells) specialFunctionCells.forEach(cell => { cell.addEventListener('input', () => updateSpecialFunctionVisuals(cell)); });
            if (sheetSelectorContainer) sheetSelectorContainer.addEventListener('click', (e) => { if (e.target.matches('.sheet-selector-btn')) { switchSheet(e.target.dataset.sheet); } });
            if (limpaBtn) limpaBtn.addEventListener('click', clearCurrentSheet);
            if (gravarBtn) gravarBtn.addEventListener('click', saveSimulationToDatabase);
            if (restaurarBtn) restaurarBtn.addEventListener('click', () => { alert("Lembrar de ativar essa função"); });
            if (executeMacroBtn) executeMacroBtn.addEventListener('click', executeMacro);
            if (saveLayoutBtn) saveLayoutBtn.addEventListener('click', saveLayoutToDatabase);
            
            const importBtn = document.getElementById('import-txt-btn');
            if (importBtn) {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.txt,text/plain';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                importBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileImport);
            }
            
            const extractExcelBtn = document.getElementById('extract-excel-layout-btn');
            const excelLayoutInput = document.getElementById('excel-layout-input');

            if (extractExcelBtn && excelLayoutInput) {
                extractExcelBtn.addEventListener('click', () => {
                    excelLayoutInput.click(); 
                });

                excelLayoutInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    extractExcelBtn.disabled = true;
                    extractExcelBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processando...';
                    
                    try {
                        const { layout, newBlockLayout } = await processExcelLayout(file);
                        
                        if (layout.length > 0) {
                            activeBlockLayout = newBlockLayout;
                            initializeBlocks(activeBlockLayout);

                            columnColors = {}; 
                            const uniqueColorMapping = {};
                            
                            layout.forEach(item => {
                                if (!uniqueColorMapping[item.module]) {
                                    uniqueColorMapping[item.module] = item.color;
                                }
                            });

                            for (const moduleNumber in uniqueColorMapping) {
                                const color = uniqueColorMapping[moduleNumber];
                                const colIndex = parseInt(moduleNumber, 10) - 1;
                                if (colIndex >= 0 && colIndex < 24) {
                                    applyColumnColor(colIndex.toString(), color);
                                }
                            }
                            alert('Layout de cores e visual extraídos e aplicados com sucesso!');
                        }

                    } catch (error) {
                        console.error("Erro ao extrair layout do Excel:", error);
                        alert(`Falha ao processar o arquivo Excel. Detalhes: ${error.message}`);
                    } finally {
                        extractExcelBtn.disabled = false;
                        extractExcelBtn.innerHTML = '<i class="fa fa-file-excel"></i> Extrair Layout Excel';
                        excelLayoutInput.value = '';
                    }
                });
            } else {
                console.error("ERRO: Botão de extração de Excel ou input de arquivo não encontrado!");
            }

            const exportGifBtn = document.getElementById('export-gif-btn');
            if(exportGifBtn) { exportGifBtn.addEventListener('click', exportAllSimulationsAsGifs); }
            
            const editLayoutBtn = document.getElementById('edit-layout-btn');
            if (editLayoutBtn && simulationArea) {
                editLayoutBtn.addEventListener('click', () => {
                    isEditMode = !isEditMode;
                    simulationArea.classList.toggle('edit-mode', isEditMode);
                    if (isEditMode) {
                        editLayoutBtn.innerHTML = '<i class="fa fa-check"></i> Concluir Edição';
                        editLayoutBtn.style.backgroundColor = '#2ecc71';
                        if (saveLayoutBtn) saveLayoutBtn.style.display = 'inline-block';
                        stopSimulation(); 
                    } else {
                        editLayoutBtn.innerHTML = '<i class="fa fa-pencil"></i> Editar Layout';
                        editLayoutBtn.style.backgroundColor = '#3498db';
                        if (saveLayoutBtn) saveLayoutBtn.style.display = 'none';
                        if (currentLayout) {
                            currentLayout.blocks = JSON.parse(JSON.stringify(activeBlockLayout));
                        }
                        if(activeBlock) { activeBlock.classList.remove('selected'); activeBlock = null; }
                    }
                });
            }

            const hideContextMenu = () => {
                colorContextMenu.style.display = 'none';
                window.removeEventListener('click', hideContextMenu);
            };

            const showColorMenu = (e) => {
                const headerCell = e.target.closest('th.column-header[data-col-index]');
                if (headerCell) {
                    e.preventDefault();
                    
                    colorContextMenu.style.display = 'block';
                    colorContextMenu.style.top = `${e.clientY}px`;
                    colorContextMenu.style.left = `${e.clientX}px`;
                    colorContextMenu.dataset.editingCol = headerCell.dataset.colIndex;

                    setTimeout(() => {
                        window.addEventListener('click', hideContextMenu, { once: true });
                    }, 0);
                }
            };
            
            if (macroHeader) macroHeader.addEventListener('contextmenu', showColorMenu);

            if (colorContextMenu) colorContextMenu.addEventListener('click', e => {
                e.stopPropagation();
                const target = e.target.closest('li[data-color]');
                if (target) {
                    const colIndex = colorContextMenu.dataset.editingCol;
                    const color = target.dataset.color;
                    applyColumnColor(colIndex, color);
                    hideContextMenu();
                }
            });

            if (blocksContainer) blocksContainer.addEventListener('mousedown', (e) => {
                if (!isEditMode) return;
                const target = e.target;
                
                if (target.isContentEditable) {
                    return;
                }
                const blockElement = target.closest('.block-container');
                if (!blockElement) {
                    if (activeBlock) {
                        activeBlock.classList.remove('selected');
                        activeBlock = null;
                    }
                    return;
                };
                e.preventDefault();
                if (activeBlock && activeBlock !== blockElement) { activeBlock.classList.remove('selected'); }
                activeBlock = blockElement;
                activeBlock.classList.add('selected');
                const initialMouseX = e.clientX;
                const initialMouseY = e.clientY;
                const blockRect = activeBlock.getBoundingClientRect();
                if (target.classList.contains('resize-handle')) {
                    action = { type: 'resize', initialWidth: blockRect.width, initialHeight: blockRect.height, initialMouseX, initialMouseY };
                } else if (target.classList.contains('rotate-handle')) {
                    const centerX = blockRect.left + blockRect.width / 2;
                    const centerY = blockRect.top + blockRect.height / 2;
                    action = { type: 'rotate', centerX, centerY };
                } else {
                    const initialTop = activeBlock.offsetTop;
                    const initialLeft = activeBlock.offsetLeft;
                    action = { type: 'move', initialTop, initialLeft, initialMouseX, initialMouseY };
                }
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            function onMouseMove(e) {
                if (!action || !activeBlock) return;
                const blockData = activeBlockLayout[activeBlock.dataset.index];
                const containerRect = simulationArea.getBoundingClientRect();
                if (action.type === 'move') {
                    const dx = e.clientX - action.initialMouseX;
                    const dy = e.clientY - action.initialMouseY;
                    activeBlock.style.left = `${((action.initialLeft + dx) / containerRect.width) * 100}%`;
                    activeBlock.style.top = `${((action.initialTop + dy) / containerRect.height) * 100}%`;
                    blockData.left = activeBlock.style.left;
                    blockData.top = activeBlock.style.top;
                } 
                else if (action.type === 'resize') {
                    const dx = e.clientX - action.initialMouseX;
                    const dy = e.clientY - action.initialMouseY;
                    let newWidth = action.initialWidth + dx;
                    let newHeight = action.initialHeight + dy;
                    if (newWidth > 20) { activeBlock.style.width = `${newWidth}px`; blockData.width = newWidth; }
                    if (newHeight > 10) { activeBlock.style.height = `${newHeight}px`; blockData.height = newHeight; }
                }
                else if (action.type === 'rotate') {
                    const angleRad = Math.atan2(e.clientY - action.centerY, e.clientX - action.centerX);
                    let angleDeg = angleRad * (180 / Math.PI) + 90;
                    activeBlock.style.transform = `rotate(${angleDeg}deg)`;
                    blockData.rotate = angleDeg;
                }
            }
            function onMouseUp() {
                action = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }
        
        function clearSelection() {
            selection.forEach(cell => cell.classList.remove('cell-selected'));
            selection.clear();
        }

        function toggleSpecialFunction(funcName) {
            if (activeSpecialFunctions[funcName]) {
                delete activeSpecialFunctions[funcName];
            } else {
                const onList = savedSpecialFunctionConfigs[funcName + '_on'] || [];
                const macroData = allMacroData[activeSheet];
                const newColors = {};
                onList.forEach(blockNumber => {
                    let foundColor = null;
                    for (const row of macroData) {
                        const colorValue = row.values[blockNumber - 1];
                        if (colorValue && ['1', '2', '3', '4'].includes(colorValue)) {
                            foundColor = parseInt(colorValue, 10);
                            break; 
                        }
                    }
                    newColors[blockNumber] = foundColor || 3;
                });
                activeSpecialFunctions[funcName] = { colors: newColors };
            }
            if (!isSimulationRunning) { renderLights(); }
            updateSpecialFunctionUI();
        }

        function updateSpecialFunctionUI() {
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            for (const funcName in activeSpecialFunctions) {
                let btnId;
                if (funcName === 'takedown') btnId = 'btn-td';
                if (funcName === 'alley_left') btnId = 'btn-le';
                if (funcName === 'alley_right') btnId = 'btn-ld';
                if (btnId) {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.classList.add('active');
                }
            }
        }
        
        function triggerMacro(sheetName) {
            if (isSimulationRunning && activeSheet === sheetName) {
                stopSimulation();
                return;
            }
            if (!sheetNames.includes(sheetName)) {
                console.warn(`Tentativa de executar macro para uma aba inexistente: ${sheetName}`);
                return;
            }
            stopSimulation();
            setTimeout(() => {
                switchSheet(sheetName);
                executeMacro();
            }, 100); 
        }

        function executeMacro() {
            if (isSimulationRunning) {
                stopSimulation();
                return;
            }
            allMacroData[activeSheet] = getCurrentTableData();
            const rawData = allMacroData[activeSheet];
            
            const macroSteps = [];
            for (let i = 0; i < rawData.length; i++) {
                const row = rawData[i];
                const msValue = parseInt(row.ms, 10);

                if (isNaN(msValue) || row.ms.trim() === '') {
                    break;
                }
                
                macroSteps.push({ ...row, originalIndex: i });

                if (msValue === 0) {
                    break;
                }
            }

            if (macroSteps.length === 0) {
                alert('Nenhum passo válido encontrado na planilha para iniciar a simulação!');
                return;
            }
            
            startSimulation(macroSteps);
        }
        
        function startSimulation(macroData) {
            isSimulationRunning = true;
            executeMacroBtn.textContent = 'Parar Macro';
            executeMacroBtn.style.backgroundColor = '#dc3545';
            let currentStep = 0;
            function runStep() {
                if (!isSimulationRunning) return;
                
                const step = macroData[currentStep];
                if(!step) {
                    currentStep = 0;
                    runStep();
                    return;
                }
                
                const stepTime = parseInt(step.ms, 10);
                if (stepTime === 0) { 
                    currentStep = 0; 
                    runStep(); 
                    return; 
                }

                const values = step.values.map(v => parseInt(v, 10) || 0);
                renderLights(values);
                highlightCurrentRow(step.originalIndex);
                currentStep++;

                if (currentStep >= macroData.length) {
                    currentStep = 0;
                }

                simulationStopper = setTimeout(runStep, stepTime);
            }
            runStep();
        }
        
        function stopSimulation() {
            isSimulationRunning = false;
            if (executeMacroBtn) {
                executeMacroBtn.textContent = 'Executar Macro';
                executeMacroBtn.style.backgroundColor = '#f39c12';
            }
            clearTimeout(simulationStopper);
            simulationStopper = null;
            renderLights();
            document.querySelectorAll('#macro-body tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
        }
        
        function renderLights(macroValues = []) {
            const finalOnColors = {};
            const finalOffList = [];
            const colorClassMap = { red: 'layout-color-red', green: 'layout-color-green', blue: 'layout-color-blue', white: 'layout-color-white', yellow: 'layout-color-yellow' };
            
            for (const funcName in activeSpecialFunctions) {
                const offConfig = savedSpecialFunctionConfigs[funcName] || [];
                offConfig.forEach(blockNum => finalOffList.push(blockNum));
                const onConfig = activeSpecialFunctions[funcName].colors || {};
                for (const blockNum in onConfig) {
                    finalOnColors[blockNum] = onConfig[blockNum];
                }
            }
            const cutHornList = savedSpecialFunctionConfigs.cut_horn_light || [];
            cutHornList.forEach(blockNum => finalOffList.push(blockNum));
            let brightness = 1.0;
            if (savedJumpTabelaSettings['jt2_bit7']) brightness = 0.75;
            if (savedJumpTabelaSettings['jt2_bit6']) brightness = 0.50;

            document.querySelectorAll('[data-block-num]').forEach((partElement) => {
                const blockNumber = parseInt(partElement.dataset.blockNum, 10);
                if (isNaN(blockNumber)) return;

                const blockContainer = partElement.closest('.block-container');
                const columnIndex = blockNumber - 1;
                
                let finalColorValue = macroValues[columnIndex] || 0;
                if (finalOnColors.hasOwnProperty(blockNumber)) { finalColorValue = finalOnColors[blockNumber]; }
                if (finalOffList.includes(blockNumber)) { finalColorValue = 0; }
                
                partElement.className = partElement.className.replace(/layout-color-\w+/g, '').trim();
                partElement.classList.add('layout-color-off');

                if (blockContainer) {
                    blockContainer.style.opacity = 1.0;
                }

                if (finalColorValue > 0) {
                    if (blockContainer) {
                        blockContainer.style.opacity = brightness;
                    }
                    const persistentColor = columnColors[columnIndex];
                    let colorToApply = '';

                    if (persistentColor && colorClassMap[persistentColor]) {
                        colorToApply = colorClassMap[persistentColor];
                    } else {
                        switch (finalColorValue) {
                            case 1: colorToApply = 'layout-color-red'; break;
                            case 2: colorToApply = 'layout-color-blue'; break;
                            case 3: colorToApply = 'layout-color-white'; break;
                            case 4: colorToApply = 'layout-color-yellow'; break;
                        }
                    }
                    
                    if (colorToApply) {
                        partElement.classList.remove('layout-color-off');
                        partElement.classList.add(colorToApply);
                    }
                }
            });
        }

        function previewRow(rowIndex) {
            if (isSimulationRunning) return;
            const tableData = getCurrentTableData();
            if (rowIndex >= 0 && rowIndex < tableData.length) {
                const rowData = tableData[rowIndex];
                const values = rowData.values.map(v => parseInt(v, 10) || 0);
                renderLights(values);
            }
        }

        function highlightCurrentRow(rowIndex) {
            document.querySelectorAll('#macro-body tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
            const targetRow = macroTableBody.rows[rowIndex];
            if (targetRow) {
                targetRow.classList.add('selected-row');
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                previewRow(rowIndex);
            }
        }
        
        function getCurrentTableData() {
            return Array.from(macroTableBody.rows).map(row => {
                const cells = Array.from(row.cells);
                return {
                    row: cells[2].textContent.trim(),
                    ms: cells[1].textContent.trim(),
                    values: cells.slice(3).map(cell => cell.textContent.trim())
                };
            });
        }
        
        function switchSheet(newSheetName, preventSave = false) {
            if (activeSheet === newSheetName) return;
            if (!preventSave) {
                allMacroData[activeSheet] = getCurrentTableData();
            }
            activeSheet = newSheetName;
            renderTable(allMacroData[activeSheet]);
            updateActiveSheetUI();
            updateConsumptionDisplay();
        }
        
        function updateActiveSheetUI() {
            document.querySelectorAll('.sheet-selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sheet === activeSheet);
            });
        }
        
        function clearCurrentSheet() {
            if (confirm(`Tem certeza que deseja limpar todos os dados da planilha "${activeSheet}"? Esta ação pode ser desfeita com Ctrl+Z.`)) {
                pushStateToUndoHistory();
                allMacroData[activeSheet] = JSON.parse(JSON.stringify(baseSheetStructure));
                columnColors = {};
                renderTable(allMacroData[activeSheet]);
                updateConsumptionDisplay();
            }
        }
        
        function saveAdvancedSettings() {
            const currentModalConfigs = readCurrentModalState();
            savedSpecialFunctionConfigs = currentModalConfigs.specialFunctions;
            savedJumpTabelaSettings = currentModalConfigs.jumpTabela;
            renderAllActiveSettings();
            alert('Definições avançadas salvas!');
            advancedSettingsModal.style.display = 'none';
        }

        function readCurrentModalState() {
            const specialFunctions = {};
            document.querySelectorAll('#tab-special-functions .function-table-container').forEach(container => {
                const funcName = container.querySelector('td[data-function]').dataset.function;
                const cells = container.querySelectorAll('td[data-block]');
                const currentValues = [];
                cells.forEach(cell => {
                    if (cell.textContent.trim() === '1') {
                        currentValues.push(parseInt(cell.dataset.block, 10));
                    }
                });
                if(currentValues.length > 0) {
                   specialFunctions[funcName] = currentValues;
                }
            });
            
            const jumpTabela = {};
            jumpTabelaCheckboxes.forEach(checkbox => {
                const key = `jt${checkbox.dataset.jumptabela}_bit${checkbox.dataset.bit}`;
                jumpTabela[key] = checkbox.checked;
            });

            return { specialFunctions, jumpTabela };
        }
        
        function updateAllVisuals() {
            updateJumpTabelaVisuals();
            specialFunctionCells.forEach(cell => updateSpecialFunctionVisuals(cell));
        }
        
        function updateJumpTabelaVisuals() {
            jumpTabelaCheckboxes.forEach(checkbox => {
                checkbox.closest('.checkbox-item').classList.toggle('active-setting', checkbox.checked);
            });
        }
        
        function updateSpecialFunctionVisuals(cell) {
           cell.classList.toggle('cell-active-function', cell.textContent.trim() === '1');
        }
        
        function renderAllActiveSettings() {
            renderActiveSpecialFunctions();
            renderActiveJumpTabelaSettings();
        }
        
        function renderActiveSpecialFunctions() {
            specialFunctionsStatusContainer.innerHTML = '';
            const functionNamesMap = {
                takedown: 'Take Down (Apagar)', takedown_on: 'Take Down (Acender)',
                alley_right: 'Alley-Right (LD - Apagar)', alley_right_on: 'Alley-Right (LD - Acender)',
                alley_left: 'Alley-Left (LE - Apagar)', alley_left_on: 'Alley-Left (LE - Acender)',
                backlight_off: 'Backlight (Apagar)', backlight_on: 'Backlight (Acender)',
                cut_front_off: 'Cut Front (Apagar)', cut_front_on: 'Cut Front (Acender)',
                cut_rear_off: 'Cut Rear (Apagar)', cut_rear_on: 'Cut Rear (Acender)',
                cut_dt_off: 'Cut DT (Apagar)', cut_dt_on: 'Cut DT (Acender)',
                cut_horn_light: 'Cut Horn Light'
            };
            
            const activeFunctions = [];
            for (const funcKey in savedSpecialFunctionConfigs) {
                const configArray = savedSpecialFunctionConfigs[funcKey];
                if (configArray && configArray.length > 0) {
                    const funcName = functionNamesMap[funcKey] || funcKey;
                    const blocksText = configArray.join(', ');
                    activeFunctions.push(`<span class="func-name">${funcName}:</span> Bloco(s) ${blocksText}`);
                }
            }
            
            if (activeFunctions.length > 0) {
                const ul = document.createElement('ul');
                activeFunctions.forEach(text => {
                    const li = document.createElement('li');
                    li.innerHTML = text;
                    ul.appendChild(li);
                });
                specialFunctionsStatusContainer.appendChild(ul);
            } else {
                specialFunctionsStatusContainer.innerHTML = '<p class="no-settings">Nenhuma função especial ativa.</p>';
            }
        }
        
        function renderActiveJumpTabelaSettings() {
            jumpTabelaStatusContainer.innerHTML = '';
            const activeSettings = [];
            for (const key in savedJumpTabelaSettings) {
                if (savedJumpTabelaSettings[key]) {
                    const checkbox = document.querySelector(`[data-jumptabela="${key[2]}"][data-bit="${key[8]}"]`);
                    if (checkbox) {
                        activeSettings.push(checkbox.parentElement.textContent.trim());
                    }
                }
            }
            
            if (activeSettings.length > 0) {
                const ul = document.createElement('ul');
                activeSettings.forEach(text => {
                    const li = document.createElement('li');
                    li.textContent = text;
                    ul.appendChild(li);
                });
                jumpTabelaStatusContainer.appendChild(ul);
            } else {
                jumpTabelaStatusContainer.innerHTML = '<p class="no-settings">Nenhuma configuração global ativa.</p>';
            }
        }
        
        function initializeInteractionHandlers() {
            let isMouseDown = false, startCell = null;
            if (macroTableBody) macroTableBody.addEventListener('mousedown', e => {
                const targetCell = e.target.closest('td[contenteditable="true"]');
                if (!targetCell) return;
                isMouseDown = true;
                startCell = targetCell;
                if (!e.shiftKey) {
                    clearSelection();
                    selection.add(targetCell);
                    targetCell.classList.add('cell-selected');
                }
            });
            if (macroTableBody) macroTableBody.addEventListener('mousemove', e => {
                if (!isMouseDown) return;
                document.body.style.userSelect = 'none';
                const endCell = e.target.closest('td[contenteditable="true"]');
                if (!endCell) return;
                clearSelection();
                const allRows = Array.from(macroTableBody.rows);
                const startRowIndex = startCell.parentElement.rowIndex; const endRowIndex = endCell.parentElement.rowIndex;
                const startCellIndex = startCell.cellIndex; const endCellIndex = endCell.cellIndex;
                const minRow = Math.min(startRowIndex, endRowIndex); const maxRow = Math.max(startRowIndex, endRowIndex);
                const minCol = Math.min(startCellIndex, endCellIndex); const maxCol = Math.max(startCellIndex, endCellIndex);
                for (let i = minRow; i <= maxRow; i++) {
                    const row = allRows[i - 1];
                    if (row) {
                        for (let j = minCol; j <= maxCol; j++) {
                            const cell = row.cells[j];
                            if (cell && cell.hasAttribute('contenteditable')) {
                                cell.classList.add('cell-selected');
                                selection.add(cell);
                            }
                        }
                    }
                }
            });
            document.addEventListener('mouseup', () => {
                isMouseDown = false;
                document.body.style.userSelect = '';
                startCell = null;
            });
            document.addEventListener('keydown', e => {
                if (isEditMode && activeBlock) {
                    if (e.key === 'Delete') {
                        e.preventDefault();
                        const indexToRemove = parseInt(activeBlock.dataset.index, 10);
                        activeBlockLayout.splice(indexToRemove, 1);
                        activeBlock = null;
                        initializeBlocks(activeBlockLayout);
                        return;
                    }
                    if (e.ctrlKey && e.key.toLowerCase() === 'c') {
                        e.preventDefault();
                        const indexToCopy = parseInt(activeBlock.dataset.index, 10);
                        copiedBlockData = JSON.parse(JSON.stringify(activeBlockLayout[indexToCopy]));
                        activeBlock.style.outline = '2px dashed green';
                        setTimeout(() => { if(activeBlock) activeBlock.style.outline = ''; }, 300);
                        return;
                    }
                }
                if (isEditMode && e.ctrlKey && e.key.toLowerCase() === 'v' && copiedBlockData) {
                    e.preventDefault();
                    const newBlock = JSON.parse(JSON.stringify(copiedBlockData));
                    const currentLeft = parseFloat(newBlock.left);
                    const currentTop = parseFloat(newBlock.top);
                    newBlock.left = `${currentLeft + 2}%`;
                    newBlock.top = `${currentTop + 2}%`;
                    activeBlockLayout.push(newBlock);
                    initializeBlocks(activeBlockLayout);
                    return;
                }

                if (e.ctrlKey) {
                    switch (e.key.toLowerCase()) {
                        case 'c': if (selection.size > 0) { e.preventDefault(); const cells = Array.from(selection); const minRow = Math.min(...cells.map(c => c.parentElement.rowIndex)); const minCol = Math.min(...cells.map(c => c.cellIndex)); clipboardData = cells.map(cell => ({ row: cell.parentElement.rowIndex - minRow, col: cell.cellIndex - minCol, value: cell.textContent })); cells.forEach(c => { c.style.outline = '1px dashed #0070c0'; }); setTimeout(() => cells.forEach(c => { c.style.outline = ''; }), 200); } break;
                        case 'v': if (clipboardData && selection.size > 0) { e.preventDefault(); pushStateToUndoHistory(); let affectedCellsForSync = []; if (selection.size > 1) { const clipboardHeight = Math.max(...clipboardData.map(c => c.row)) + 1; const clipboardWidth = Math.max(...clipboardData.map(c => c.col)) + 1; const clipboardMap = new Map(); clipboardData.forEach(c => clipboardMap.set(`${c.row},${c.col}`, c.value)); const selectedCells = Array.from(selection); affectedCellsForSync = selectedCells; const minSelectedRow = Math.min(...selectedCells.map(c => c.parentElement.rowIndex)); const minSelectedCol = Math.min(...selectedCells.map(c => c.cellIndex)); selectedCells.forEach(cell => { const relativeRow = cell.parentElement.rowIndex - minSelectedRow; const relativeCol = cell.cellIndex - minSelectedCol; const sourceRow = relativeRow % clipboardHeight; const sourceCol = relativeCol % clipboardWidth; const valueToPaste = clipboardMap.get(`${sourceRow},${sourceCol}`); if (valueToPaste !== undefined) { cell.textContent = valueToPaste; updateCellColor(cell); } }); } else if (selection.size === 1) { const targetCell = Array.from(selection)[0]; const startRow = targetCell.parentElement.rowIndex; const startCol = targetCell.cellIndex; const allRows = Array.from(macroTableBody.rows); clipboardData.forEach(clip => { const targetRowIndex = startRow + clip.row - 1; const targetColIndex = startCol + clip.col; if (allRows[targetRowIndex]) { const finalCell = allRows[targetRowIndex].cells[targetColIndex]; if (finalCell && finalCell.isContentEditable) { finalCell.textContent = clip.value; updateCellColor(finalCell); affectedCellsForSync.push(finalCell); } } }); } affectedCellsForSync.forEach(cell => { if (cell.classList.contains('ms25-column')) { const msCell = cell.nextElementSibling; if (msCell) syncTimeValues(cell, msCell, 'from_ms25'); } else if (cell.classList.contains('ms-column')) { const ms25Cell = cell.previousElementSibling; if (ms25Cell) syncTimeValues(ms25Cell, cell, 'from_ms'); } }); updateConsumptionDisplay(); } break;
                        case 'z': e.preventDefault(); const undoHistoryForSheet = undoHistory[activeSheet]; if (undoHistoryForSheet && undoHistoryForSheet.length > 0) { const previousState = undoHistoryForSheet.pop(); redoHistory[activeSheet].push(getCurrentTableData()); allMacroData[activeSheet] = previousState; renderTable(allMacroData[activeSheet]); updateConsumptionDisplay(); } break;
                        case 'y': e.preventDefault(); const redoHistoryForSheet = redoHistory[activeSheet]; if(redoHistoryForSheet && redoHistoryForSheet.length > 0) { const nextState = redoHistoryForSheet.pop(); undoHistory[activeSheet].push(getCurrentTableData()); allMacroData[activeSheet] = nextState; renderTable(allMacroData[activeSheet]); updateConsumptionDisplay(); } break;
                    }
                    return; 
                }
                const activeEl = document.activeElement;
                if (activeEl && activeEl.closest('.function-table')) { const currentCell = activeEl; if (currentCell.tagName !== 'TD' || !currentCell.isContentEditable) return; const currentRow = currentCell.parentElement; const currentCellIndex = currentCell.cellIndex; let nextCell; switch (e.key) { case 'Enter': case 'ArrowDown': e.preventDefault(); let nextRow = currentRow.nextElementSibling; if (nextRow) { nextCell = nextRow.cells[currentCellIndex]; } else { const currentTableContainer = currentRow.closest('.function-table-container'); const nextTableContainer = currentTableContainer.nextElementSibling; if (nextTableContainer && nextTableContainer.classList.contains('function-table-container')) { nextCell = nextTableContainer.querySelector('tbody tr').cells[currentCellIndex]; } } break; case 'ArrowUp': e.preventDefault(); let prevRow = currentRow.previousElementSibling; if (prevRow) { nextCell = prevRow.cells[currentCellIndex]; } else { const currentTableContainer = currentRow.closest('.function-table-container'); const prevTableContainer = currentTableContainer.previousElementSibling; if (prevTableContainer && prevTableContainer.classList.contains('function-table-container')) { nextCell = prevTableContainer.querySelector('tbody tr:last-child').cells[currentCellIndex]; } } break; case 'ArrowLeft': if (window.getSelection().anchorOffset === 0) { e.preventDefault(); nextCell = currentCell.previousElementSibling; } break; case 'ArrowRight': if (window.getSelection().anchorOffset === currentCell.textContent.length || currentCell.textContent.length === 0) { e.preventDefault(); nextCell = currentCell.nextElementSibling; } break; } if (nextCell && nextCell.hasAttribute('contenteditable')) { nextCell.focus(); } return; }
                if (selection.size > 0 || (activeEl && activeEl.closest('.macro-table'))) { 
                    if (e.key === 'Delete' || e.key === 'Backspace') { 
                        e.preventDefault(); 
                        pushStateToUndoHistory(); 
                        selection.forEach(cell => { 
                            if (cell.isContentEditable) { 
                                cell.textContent = ''; 
                                if(cell.classList.contains('editable-cell')) updateCellColor(cell); 
                            } 
                        }); 
                        updateConsumptionDisplay(); 
                        return; 
                    } 
                    if (selection.size > 1 && /[1-4]/.test(e.key)) { 
                        e.preventDefault(); 
                        pushStateToUndoHistory(); 
                        selection.forEach(cell => { 
                            if (cell.classList.contains('editable-cell')) { 
                                cell.textContent = e.key; 
                                updateCellColor(cell); 
                            } 
                        }); 
                        updateConsumptionDisplay(); 
                        return; 
                    } 
                    if (activeEl.isContentEditable) { const currentCell = activeEl; const currentRow = currentCell.parentElement; const currentCellIndex = currentCell.cellIndex; let nextCell; switch (e.key) { case 'Enter': case 'ArrowDown': e.preventDefault(); if (currentRow.nextElementSibling) nextCell = currentRow.nextElementSibling.cells[currentCellIndex]; break; case 'ArrowUp': e.preventDefault(); if(currentRow.previousElementSibling) nextCell = currentRow.previousElementSibling.cells[currentCellIndex]; break; case 'ArrowLeft': if (window.getSelection().anchorOffset === 0) { e.preventDefault(); nextCell = currentCell.previousElementSibling; } break; case 'ArrowRight': if (window.getSelection().anchorOffset === currentCell.textContent.length || currentCell.textContent.length === 0) { e.preventDefault(); nextCell = currentCell.nextElementSibling; } break; } if (nextCell && nextCell.hasAttribute('contenteditable')) { nextCell.focus(); clearSelection(); selection.add(nextCell); nextCell.classList.add('cell-selected'); } } 
                }
            });
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    parseAndApplyTxtData(content);
                    alert('Arquivo TXT importado com sucesso!');
                } catch (error) {
                    console.error("ERRO CRÍTICO ao processar o arquivo TXT:", error);
                    alert(`Falha ao importar o arquivo. Verifique o formato e o console (F12).\nErro: ${error.message}`);
                }
                event.target.value = ''; 
            };
            reader.onerror = () => {
                alert('Não foi possível ler o arquivo.');
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function parseNumericValue(val) {
            if (typeof val !== 'string') return val;
            const cleanVal = val.trim().toUpperCase();
            if (cleanVal.startsWith('0B')) return parseInt(cleanVal.substring(2), 2);
            if (cleanVal.startsWith('0X')) return parseInt(cleanVal.substring(2), 16);
            const num = parseInt(cleanVal, 10);
            return isNaN(num) ? null : num;
        }
        
        function bytesToTableValues(byteParaCols17a24, byteParaCols9a16, byteParaCols1a8) {
            const values = Array(24).fill(''); 
            const bytes = [byteParaCols1a8, byteParaCols9a16, byteParaCols17a24];
            for (let byteIndex = 0; byteIndex < 3; byteIndex++) {
                const byteVal = bytes[byteIndex];
                if (byteVal === null) continue;
                for (let bitIndex = 0; bitIndex < 8; bitIndex++) {
                    if ((byteVal >> bitIndex) & 1) { 
                        const columnIndex = (byteIndex * 8) + bitIndex;
                        if (columnIndex < 24) {
                            values[columnIndex] = '1'; 
                        }
                    }
                }
            }
            return values;
        }
        
        function parseAndApplyTxtData(content) {
            const populatedSheets = new Set();
            const tempData = {}; // Objeto temporário para guardar os dados lidos

            const paternsRegex = /Paterns\s*\[\s*[^\]]+\]\s*=\s*\{([\s\S]*?)\};/;
            const paternsMatch = content.match(paternsRegex);
            if (!paternsMatch) {
                throw new Error("Bloco de dados 'Paterns' não foi encontrado no arquivo.");
            }
            const paternsData = paternsMatch[1];
            const sheetMap = { 'DS-Right': 'DS-R', 'DS-Left': 'DS-L', 'DS-Center': 'DS-C', 'Hazard': 'HZD', 'Emergency': 'EM1', 'FP1': 'FP1', 'FP2': 'FP2', 'FP3': 'FP3', 'FP4': 'FP4', 'AUX1': 'AUX1', 'AUX2': 'AUX2', 'AUX3': 'AUX3', 'AUX4': 'AUX4'};
            const sheetMapKeys = Object.keys(sheetMap).sort((a, b) => b.length - a.length);

            const lines = paternsData.split('\n');
            let currentSheetName = null;
            let firstPopulatedSheet = null;

            for (const line of lines) {
                const cleanedLine = line.trim();
                if (!cleanedLine) continue;

                let isHeader = false;
                if (cleanedLine.startsWith('//')) {
                    for (const key of sheetMapKeys) {
                        const headerRegex = new RegExp(`//.*${key.replace('-', '\\-')}`, 'i');
                         if (headerRegex.test(cleanedLine)) {
                             if (/inicio de/i.test(cleanedLine)) {
                                 currentSheetName = sheetMap[key];
                                 if (currentSheetName && !populatedSheets.has(currentSheetName)) {
                                     tempData[currentSheetName] = []; // Inicia um array temporário
                                     populatedSheets.add(currentSheetName);
                                 }
                                 if (!firstPopulatedSheet) firstPopulatedSheet = currentSheetName;
                             } else if (/fim de/i.test(cleanedLine)) {
                                 currentSheetName = null;
                             }
                             isHeader = true;
                             break;
                         }
                       }
                }

                if (isHeader) continue;

                if (currentSheetName && /^\d|,/.test(cleanedLine)) {
                    const dataLine = cleanedLine.replace(/\/\/.*$/, '').trim();
                    let parts = dataLine.split(',').map(p => p.trim()).filter(Boolean);
                    
                    const numericParts = parts.filter(p => /^(-?\d+|0B[01]+|0X[0-9A-F]+)$/i.test(p));
                    
                    if (numericParts.length >= 4) {
                        const timeTicks = parseNumericValue(numericParts[0]);
                        const flags = /0x80/i.test(parts.join(',')) ? 0x80 : 0x00;
                        const byteA = parseNumericValue(numericParts[numericParts.length - 3]);
                        const byteB = parseNumericValue(numericParts[numericParts.length - 2]);
                        const byteC = parseNumericValue(numericParts[numericParts.length - 1]);

                        if (timeTicks !== null) {
                            const values = bytesToTableValues(byteA, byteB, byteC);
                            tempData[currentSheetName].push({ ms: (timeTicks * 25).toString(), values: values });
                            
                            if ((flags & 0x80) !== 0) {
                                tempData[currentSheetName].push({ ms: '0', values: Array(24).fill('') });
                                currentSheetName = null;
                            }
                        }
                    }
                }
            }
            
            // Mescla os dados lidos na estrutura fixa
            sheetNames.forEach(name => {
                const newSheetData = JSON.parse(JSON.stringify(baseSheetStructure)); 

                if (populatedSheets.has(name)) {
                    const parsedRows = tempData[name];
                    for (let i = 0; i < parsedRows.length; i++) {
                        if (i < newSheetData.length) { 
                            newSheetData[i] = parsedRows[i];
                        }
                    }
                }
                
                newSheetData.forEach((row, index) => {
                    row.row = index + 1;
                });
                
                allMacroData[name] = newSheetData;
            });

            switchSheet(firstPopulatedSheet || 'FP1', true);
            renderAllActiveSettings();
            updateConsumptionDisplay();
        }

        function calculateConsumption(sheetData) {
            const CONSUMO_POR_MODULO = 0.82;
            let consumoTotalPonderado = 0;
            let tempoTotal = 0;
            let picoModulosAtivos = 0;

            if (!sheetData) return { media: 0, pico: 0 };

            for (const row of sheetData) {
                const msValue = parseInt(row.ms, 10);
                if (isNaN(msValue) || row.ms.trim() === '') continue;

                if (msValue === 0) break; 

                const modulosAtivosNaLinha = row.values.filter(v => v && v !== '0').length;
                if (modulosAtivosNaLinha > picoModulosAtivos) {
                    picoModulosAtivos = modulosAtivosNaLinha;
                }
                consumoTotalPonderado += modulosAtivosNaLinha * msValue;
                tempoTotal += msValue;
            }

            const mediaModulosAtivos = tempoTotal > 0 ? consumoTotalPonderado / tempoTotal : 0;
            const mediaFinalAmperes = mediaModulosAtivos * CONSUMO_POR_MODULO;
            const picoFinalAmperes = picoModulosAtivos * CONSUMO_POR_MODULO;

            return { media: mediaFinalAmperes, pico: picoFinalAmperes };
        }
        
        function updateConsumptionDisplay() {
            allMacroData[activeSheet] = getCurrentTableData();
            const results = calculateConsumption(allMacroData[activeSheet]); 
            document.getElementById('output-media-final').textContent = `${results.media.toFixed(3).replace('.',',')} A`;
            document.getElementById('output-pico').textContent = `${results.pico.toFixed(3).replace('.',',')} A`;
        }
        
        async function saveSimulationToDatabase() {
            const simulationName = prompt("Por favor, digite um nome para esta simulação:", "Simulação Padrão");
            if (!simulationName) {
                alert("Salvamento cancelado.");
                return;
            }
            allMacroData[activeSheet] = getCurrentTableData();
            const consumptionData = calculateConsumption(allMacroData[activeSheet]);
            
            if (currentLayout) {
               currentLayout.blocks = JSON.parse(JSON.stringify(activeBlockLayout));
            }

            const payload = {
                name: simulationName,
                layout_id: currentLayout.id,
                block_layout: activeBlockLayout, 
                column_colors: columnColors,
                data: allMacroData,
                consumoMedia: consumptionData.media,
                consumoPico: consumptionData.pico,
                special_functions: savedSpecialFunctionConfigs,
                jumptabela_settings: savedJumpTabelaSettings
            };
            try {
                const response = await fetch('save_simulation.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    alert('Sucesso! A simulação foi salva no banco de dados!');
                } else {
                    alert('O servidor respondeu com um erro: ' + (result.error || 'Erro desconhecido.'));
                }
            } catch (error) {
                console.error('ERRO AO SALVAR:', error);
                alert('FALHA! Ocorreu um erro ao tentar salvar a simulação. Verifique o console (F12) para detalhes.');
            }
        }
        
        async function getGifWorkerURL() {
            if (gifWorkerBlobURL) return gifWorkerBlobURL;
            try {
                const workerScriptURL = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js';
                const response = await fetch(workerScriptURL);
                if (!response.ok) throw new Error(`A resposta da rede não foi OK: ${response.statusText}`);
                const workerScriptText = await response.text();
                const blob = new Blob([workerScriptText], { type: 'application/javascript' });
                gifWorkerBlobURL = URL.createObjectURL(blob);
                return gifWorkerBlobURL;
            } catch (error) {
                console.error('Falha ao baixar o script do worker do GIF:', error);
                throw new Error('Não foi possível preparar o componente de geração de GIF. Verifique a conexão com a internet.');
            }
        }

        async function getBackgroundImageDataURL(url) {
            if (backgroundImageDataURL && backgroundImageDataURL.sourceUrl === url) {
                return backgroundImageDataURL.dataUrl;
            }
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    backgroundImageDataURL = { sourceUrl: url, dataUrl: dataURL };
                    resolve(dataURL);
                };
                img.onerror = () => {
                    console.warn(`Não foi possível carregar a imagem de fundo '${url}'. O GIF será gerado com fundo sólido.`);
                    backgroundImageDataURL = { sourceUrl: url, dataUrl: null }; 
                    resolve(null);
                };
                img.src = url;
            });
        }

        function generateGifForSheet(sheetName, progressCallback, workerURL) {
            return new Promise(async (resolve, reject) => {
                const macroData = [];
                for(const row of allMacroData[sheetName]) {
                    const ms = parseInt(row.ms, 10);
                    if (isNaN(ms)) continue;
                    if (ms === 0) break;
                    macroData.push(row);
                }
                if (macroData.length === 0) {
                    macroData.push({ ms: '1000', values: Array(24).fill('') });
                }
                const gif = new GIF({
                    workers: 2,
                    quality: 1, 
                    workerScript: workerURL
                });
                const simulationArea = document.getElementById('simulation-area');
                const bgImageDataURL = await getBackgroundImageDataURL(currentLayout.image);
                const PADDING = 80; 
                const captureCanvas = document.createElement('div');
                captureCanvas.style.position = 'absolute';
                captureCanvas.style.left = '-9999px';
                captureCanvas.style.width = `${simulationArea.offsetWidth + PADDING * 2}px`;
                captureCanvas.style.height = `${simulationArea.offsetHeight + PADDING * 2}px`;
                captureCanvas.style.display = 'flex';
                captureCanvas.style.justifyContent = 'center';
                captureCanvas.style.alignItems = 'center';
                captureCanvas.style.backgroundColor = '#e9ecef';
                const captureContainer = document.createElement('div');
                captureContainer.style.position = 'relative';
                captureContainer.style.width = `${simulationArea.offsetWidth}px`;
                captureContainer.style.height = `${simulationArea.offsetHeight}px`;
                if (bgImageDataURL) {
                    captureContainer.style.backgroundImage = `url(${bgImageDataURL})`;
                    captureContainer.style.backgroundSize = 'contain';
                    captureContainer.style.backgroundRepeat = 'no-repeat';
                    captureContainer.style.backgroundPosition = 'center';
                }
                captureCanvas.appendChild(captureContainer);
                document.body.appendChild(captureCanvas);
                try {
                    for (let i = 0; i < macroData.length; i++) {
                        const step = macroData[i];
                        const values = step.values.map(v => parseInt(v) || 0);
                        renderLights(values);
                        await new Promise(r => setTimeout(r, 20));
                        const clonedBlocks = blocksContainer.cloneNode(true);
                        captureContainer.innerHTML = '';
                        captureContainer.appendChild(clonedBlocks);
                        const canvas = await html2canvas(captureCanvas, {
                            scale: 2,
                            logging: false,
                            useCORS: true,
                            backgroundColor: null
                        });
                        gif.addFrame(canvas, { delay: parseInt(step.ms, 10) });
                        if (progressCallback) {
                            progressCallback(i + 1, macroData.length);
                        }
                    }
                } catch (error) {
                    console.error(`Falha ao capturar o quadro para a simulação ${sheetName}:`, error);
                    return reject(new Error(`Falha na captura do quadro para ${sheetName}`));
                } finally {
                    document.body.removeChild(captureCanvas);
                }
                gif.on('finished', function(blob) {
                    resolve(blob);
                });
                gif.render();
            });
        }

        async function exportAllSimulationsAsGifs() {
            const btn = document.getElementById('export-gif-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Preparando recursos...';
            try {
                const workerURL = await getGifWorkerURL();
                allMacroData[activeSheet] = getCurrentTableData();
                const zip = new JSZip();
                for (const sheetName of sheetNames) {
                    const progressCallback = (frame, totalFrames) => {
                        btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> Gerando ${sheetName} (${frame}/${totalFrames})...`;
                    };
                    const gifBlob = await generateGifForSheet(sheetName, progressCallback, workerURL);
                    if(gifBlob) {
                        zip.file(`${sheetName}.gif`, gifBlob);
                    }
                }
                if (Object.keys(zip.files).length === 0) {
                   alert("Nenhuma simulação com dados válidos encontrada para exportar.");
                } else {
                    btn.innerHTML = '<i class="fa fa-cog fa-spin"></i> Compactando...';
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `simulacoes_gifs_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert("Pacote de GIFs gerado com sucesso! O download deve começar em breve.");
                }
            } catch(error) {
                console.error("ERRO CRÍTICO DURANTE EXPORTAÇÃO DE GIFS:", error);
                alert(error.message || "Ocorreu um erro grave ao tentar gerar os GIFs. Verifique o console para detalhes.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-file-image"></i> Exportar GIFs';
                renderLights(); 
            }
        }
        
        function applyColumnColor(colIndex, color) {
            const colorClass = `persistent-color-${color}`;
            const allRows = Array.from(macroTableBody.rows);
            allRows.forEach(row => {
                const cell = row.cells[parseInt(colIndex) + 3];
                if(cell) {
                    cell.classList.remove('persistent-color-red', 'persistent-color-green', 'persistent-color-blue', 'persistent-color-white', 'persistent-color-yellow');
                }
            });
            if (color && color !== 'clear') {
                columnColors[colIndex] = color;
                allRows.forEach(row => {
                    const cell = row.cells[parseInt(colIndex) + 3];
                    if(cell) cell.classList.add(colorClass);
                });
            } else {
                delete columnColors[colIndex];
            }
        }

        function applyAllColumnColors() {
            for (const colIndex in columnColors) {
                applyColumnColor(colIndex, columnColors[colIndex]);
            }
        }

        // === INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            const templateDataJSON = localStorage.getItem('simulation_template');
            if (templateDataJSON) {
                try {
                    const loadedData = JSON.parse(templateDataJSON);
                    loadDataIntoUI(loadedData);
                    localStorage.removeItem('simulation_template');
                } catch (error) {
                    console.error("Falha ao processar template do localStorage:", error);
                    alert("Ocorreu um erro ao tentar carregar o template. Os dados podem estar corrompidos.");
                    localStorage.removeItem('simulation_template');
                }
            }
        });
    </script>
</body>
</html>